Authorities:
  - Organization: CDISC
    Standards:
      - Name: USDM
        References:
          - Citations:
              - Cited Guidance: 'Within a study design, if a planned completion number is
                  defined, it must be specified either in the study population
                  or in all cohorts.'
                Document: 'USDM_CORE_Rules.xlsx'
            Origin: 'USDM Conformance Rules'
            Rule Identifier:
              Id: 'DDF00132'
              Version: '1'
            Version: '1.0'
        Version: '3.0'
      - Name: USDM
        References:
          - Citations:
              - Cited Guidance: 'Within a study design, if a planned completion number is
                  defined, it must be specified either in the study population
                  or in all cohorts.'
                Document: 'USDM_CORE_Rules.xlsx'
            Origin: 'USDM Conformance Rules'
            Rule Identifier:
              Id: 'DDF00132'
              Version: '1'
            Version: '1.0'
        Version: '4.0'
Check: |-
  ($.**.studyDesigns)@$sd.
    $sd.population@$p.
    $p.
        [
            (
                $NullCohort:=("null" in cohorts.$type(plannedCompletionNumber) or ($count(cohorts.plannedCompletionNumber)!=$count(cohorts.id))); 
                $InCohort:=$boolean(cohorts.plannedCompletionNumber);      
                $InPop:=($type(plannedCompletionNumber) != "null" and $exists(plannedCompletionNumber));  
                $FValU:=function($n)
                    {
                        (
                            $exists($n)
                            ?   $type($n)="object"
                                ?   $exists($n.value)
                                   ? $n.value&$n.unit.standardCode.decode
                                   : $n.minValue.value&$n.minValue.unit.standardCode.decode&" to "&
                                     $n.maxValue.value&$n.maxValue.unit.standardCode.decode
                                : $string($n)
                            : "Missing"
                        )              
                    };
                    {
                        "instanceType": $p.instanceType,
                        "id": $p.id,
                        "path": $p._path,
                        "StudyDesign.id": $sd.id,
                        "StudyDesign.name": $sd.name,
                        "name": $p.name,
                        "plannedCompletionNumber(value/range)": $FValU($p.plannedCompletionNumber),
                        "cohorts.name": "["& $join($p.cohorts.(id & ": " & name),", ") & "]",
                        "cohorts.plannedCompletionNumber.id": "["& $join($p.cohorts.(id & ": " & plannedCompletionNumber.id),", ") & "]",
                        "cohorts.plannedCompletionNumber(value/range)": "["& $join($p.cohorts.(id & ": " & $FValU(plannedCompletionNumber)),", ") & "]",
                        "check": (($InPop=true and $InCohort=true) or ($InPop=false and $NullCohort=true and $InCohort=true))
                        }
            )
        ]
        [check=true]
Core:
  Id: 'DDF00132'
  Status: Draft
  Version: '1'
Description: 'Within a study design, if a planned completion number is defined,
  it must be specified either in the study population or in all cohorts.'
Executability: Fully Executable
Outcome:
  Message: 'A planned completion number has been specified for both the study
    population and one or more cohorts, or it has been specified for only a
    subset of the cohorts.'
  Output Variables:
    - StudyDesign.id
    - StudyDesign.name
    - name
    - plannedCompletionNumber(value/range)
    - cohorts.name
    - cohorts.plannedCompletionNumber.id
    - cohorts.plannedCompletionNumber(value/range)
Rule Type: JSONata
Scope:
  Entities:
    Include:
      - 'StudyDesignPopulation'
Sensitivity: Record
