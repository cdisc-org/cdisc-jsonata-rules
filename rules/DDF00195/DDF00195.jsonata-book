[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00195/DDF00195.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $old_study :=   $loadFile(\"./testdata/CDISC_Pilot_Study.json\")\r\n                    ~> |study.documentedBy.versions.dateValues.type[code=\"C99903x1\"]|{\"code\": \"C71476\",\"decode\":\"Approval Date\"}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create a copy of the first study design's population and insert it as *\r\n    * the first cohort for the (new) second study design.                   *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.**.studyDesigns[0].population,$maxids);\r\n    $new_cohort1 := $utils.make_dup($old_study.**.studyDesigns[0].population,$idmap) ~> |$|\r\n        {\r\n            \"id\": \"StudyCohort_1\",\r\n            \"name\": \"COHORT1\",\r\n            \"instanceType\": \"StudyCohort\"\r\n        },[\"plannedSex\",\"plannedEnrollmentNumber\",\"plannedCompletionNumber\",\"criterionIds\",\"cohorts\"]| ~> |plannedAge.maxValue|{\"value\": 75}|;\r\n    $new_study1 := $old_study ~> |study.versions[0].studyDesigns[0].population|{\"cohorts\": $append(cohorts,$new_cohort1)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Duplicate the cohort created in the previous step to create the       *\r\n    * second cohort for the (new) second study design.                      *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.**.studyDesigns[0].population.cohorts[0],$maxids);\r\n    $new_cohort2 := $utils.make_dup($new_study1.**.studyDesigns[0].population.cohorts[0],$idmap) ~> |$|\r\n        {\r\n            \"name\": \"COHORT2\"\r\n        }| ~> |plannedAge.minValue|{\"value\": 76}| ~> |plannedAge.maxValue|{\"value\": 100}|;\r\n    $new_study1 := $new_study1 \r\n                    ~> |study.versions[0].studyDesigns[0].population|{\"cohorts\": $append(cohorts,$new_cohort2)},[\"plannedAge\"]|;\r\n                    \r\n    /***********************************************************************\\\r\n    * Create and insert a new enrollment for the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0].enrollments[0],$maxids);\r\n    $new_en := $utils.make_dup($new_study1.study.versions[0].amendments[0].enrollments[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"ENR_2\",\r\n                    \"label\": \"Enrollment 2\",\r\n                    \"description\": \"The second enrollment\",\r\n                    \"forGeographicScope\": null,\r\n                    \"forStudySiteId\": $new_study1.study.versions[0].organizations.managedSites[0].id\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0].amendments[0]|{\"enrollments\": $append(enrollments,$new_en)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new enrollment for the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0].enrollments[0],$maxids);\r\n    $new_en := $utils.make_dup($new_study1.study.versions[0].amendments[0].enrollments[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"ENR_3\",\r\n                    \"label\": \"Enrollment 3\",\r\n                    \"description\": \"The third enrollment\",\r\n                    \"forGeographicScope\": null,\r\n                    \"forStudyCohortId\": $new_cohort2.id\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0].amendments[0]|{\"enrollments\": $append(enrollments,$new_en)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new copy of the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0],$maxids);\r\n    $new_am := $utils.make_dup($new_study1.study.versions[0].amendments[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"AMEND_2\",\r\n                    \"label\": \"Amendment 2\",\r\n                    \"description\": \"The second amendment\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0]|{\"amendments\": $append(amendments,$new_am)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new copy of the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0],$maxids);\r\n    $new_am := $utils.make_dup($new_study1.study.versions[0].amendments[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"AMEND_3\",\r\n                    \"label\": \"Amendment 3\",\r\n                    \"description\": \"The third amendment\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0]|{\"amendments\": $append(amendments,$new_am)}|;\r\n\r\n    $writeFile(\"./rules/DDF00195/unit-test-coreid-DDF00195-positive-1.json\",$new_study1);\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new copy of the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0].enrollments[0].forGeographicScope,$maxids);\r\n    $new_gs := $utils.make_dup($new_study1.study.versions[0].amendments[0].enrollments[0].forGeographicScope,$idmap);\r\n\r\n    $new_study2 :=  $new_study1\r\n      ~> |study.versions[0].amendments[0].enrollments[0]|{},[\"forGeographicScope\",\"forStudySiteId\",\"forStudyCohortId\"]|\r\n      ~> |study.versions[0].amendments[0].enrollments[1]|{\"forGeographicScope\":null,\"forStudySiteId\":null,\"forStudyCohortId\":null}|\r\n      ~> |study.versions[0].amendments[0].enrollments[2]|{\"forGeographicScope\":null,\"forStudySiteId\":\"\",\"forStudyCohortId\":\"\"}|\r\n      ~> |study.versions[0].amendments[1].enrollments[0]|{\"forStudySiteId\":$new_study1.study.versions[0].organizations.managedSites[0].id}|\r\n      ~> |study.versions[0].amendments[1].enrollments[1]|{\"forStudyCohortId\":$new_cohort2.id}|\r\n      ~> |study.versions[0].amendments[1].enrollments[2]|{\"forGeographicScope\":$new_gs}|\r\n      ~> |study.versions[0].amendments[2].enrollments[0]|{\"forStudySiteId\": \"StudySite_xx\"}|\r\n      ~> |study.versions[0].amendments[2].enrollments[1]|{\"forStudySiteId\": \"StudySite_xxx\"}|\r\n      ~> |study.versions[0].amendments[2].enrollments[2]|{\"forStudyCohortId\": \"StudyCohort_xx\"}|;\r\n\r\n    $writeFile(\"./rules/DDF00195/unit-test-coreid-DDF00195-negative-1.json\",$new_study2);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00195/unit-test-coreid-DDF00195-positive-1.json\");\r\n    $utils.report($rule,$pos_data);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00195/unit-test-coreid-DDF00195-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]