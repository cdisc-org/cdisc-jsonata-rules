[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00182/DDF00182.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $old_study :=   $loadFile(\"./testdata/CDISC_Pilot_Study.json\")\r\n                    ~> |study.documentedBy.versions.dateValues.type[code=\"C99903x1\"]|{\"code\": \"C71476\",\"decode\":\"Approval Date\"}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new version for the first study definition        *\r\n    * document version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.study.documentedBy[0].versions[0].dateValues[0],$maxids);\r\n    $new_dv := $utils.make_dup($old_study.study.documentedBy[0].versions[0].dateValues[0],$idmap)\r\n                ~> |$|  {\"name\": \"P_EFFECT\", \"label\": \"Protocol Effective\", \"dateValue\": \"2006-06-15\"}|\r\n                ~> |type|{\"code\": \"C215663\",\"decode\":\"Effective Date\" }|\r\n                ~> |geographicScopes[0].type|{\"code\": \"C68846\",\"decode\":\"Global\"}|\r\n                ~> |geographicScopes[0]|{\"code\": null}|;\r\n    $new_study1 :=  $old_study\r\n                    ~> |study.documentedBy[0].versions[0]|{\"dateValues\": $append(dateValues,$new_dv)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new version for the first study definition        *\r\n    * document version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.documentedBy[1].versions[0].dateValues[0],$maxids);\r\n    $new_dv := $utils.make_dup($new_study1.study.documentedBy[1].versions[0].dateValues[0],$idmap)\r\n                ~> |$|  {\"name\": \"P_APPROVE_AM\", \"label\": \"Protocol Approval - Americas\", \"dateValue\": \"2006-06-16\"}|\r\n                ~> |geographicScopes[0].code.standardCode|{\"code\": \"100\",\"decode\":\"Americas\"}|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.documentedBy[1].versions[0]|{\"dateValues\": $append(dateValues,$new_dv)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new version for the first study definition        *\r\n    * document version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.documentedBy[0].versions[0],$maxids);\r\n    $new_sddv := $utils.make_dup($new_study1.study.documentedBy[0].versions[0],$idmap)\r\n                ~> |$|  {\"version\": \"3\"}|\r\n                ~> |dateValues[0]|{\"dateValue\": \"2009-12-06\"}|\r\n                ~> |dateValues[1]|{\"dateValue\": \"2009-12-12\"}|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.documentedBy[0]|{\"versions\": $append(versions,$new_sddv)}|\r\n                    ~> |study.versions[0].studyDesigns[0]|{\"documentVersionIds\": [$old_study.study.documentedBy[0].versions[0].id,$new_sddv.id]}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new version for the first study definition        *\r\n    * document version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.documentedBy[0].versions[0].dateValues[0].geographicScopes[0],$maxids);\r\n    $new_gs := $utils.make_dup($new_study1.study.documentedBy[0].versions[0].dateValues[0].geographicScopes[0],$idmap)\r\n                ~> |type|{\"code\": \"C68846\",\"decode\":\"Global\"}|\r\n                ~> |$|{\"code\": null}|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.documentedBy[0].versions[0].dateValues[0]|{\"geographicScopes\": $append(geographicScopes,$new_gs)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00182/unit-test-coreid-DDF00182-positive-1.json\",$new_study1);\r\n    \r\n    /***********************************************************************\\\r\n    * Create and insert a new version for the first study definition        *\r\n    * document version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.documentedBy[0].versions[0].dateValues[0],$maxids);\r\n    $new_dv1 := $utils.make_dup($new_study1.study.documentedBy[0].versions[0].dateValues[0],$idmap)\r\n                ~> |$|  {\"name\": \"P_APPROVE_AM\", \"label\": \"Protocol Approval - Americas\", \"dateValue\": \"2006-07-15\",\"geographicScopes\": geographicScopes[0][]}|\r\n                ~> |geographicScopes[0].code.standardCode|{\"code\": \"100\",\"decode\":\"Americas\"}|;\r\n    $new_study2 :=  $new_study1\r\n                    ~> |study.documentedBy[0].versions[0]|{\"dateValues\": $append(dateValues,$new_dv1)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new version for the first study definition        *\r\n    * document version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study2);\r\n    $idmap := $utils.get_idmap($new_study2.study.documentedBy[0].versions[0].dateValues[1],$maxids);\r\n    $new_dv2 := $utils.make_dup($new_study2.study.documentedBy[0].versions[0].dateValues[1],$idmap)\r\n                ~> |$|  {\"name\": \"P_EFFECT_G2\", \"label\": \"Protocol Approval - Global\", \"dateValue\": \"2006-08-03\"}|;\r\n    $new_study2 :=  $new_study2\r\n                    ~> |study.documentedBy[0].versions[0]|{\"dateValues\": $append(dateValues,$new_dv2)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new version for the first study definition        *\r\n    * document version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study2);\r\n    $idmap := $utils.get_idmap($new_study2.study.documentedBy[1].versions[0].dateValues[0],$maxids);\r\n    $new_dv3 := $utils.make_dup($new_study2.study.documentedBy[1].versions[0].dateValues[0],$idmap)\r\n                ~> |$|  {\"name\": \"P_APPROVE_G\", \"label\": \"Protocol Approval - Global\", \"dateValue\": \"2006-06-20\"}|\r\n                ~> |geographicScopes[0].type|{\"code\": \"C68846\",\"decode\":\"Global\"}|\r\n                ~> |geographicScopes[0]|{\"code\": null}|;\r\n    $new_study2 :=  $new_study2\r\n                    ~> |study.documentedBy[1].versions[0]|{\"dateValues\": $append(dateValues,$new_dv3)}|;\r\n\r\n    $writeFile(\"./rules/DDF00182/unit-test-coreid-DDF00182-negative-1.json\",$new_study2);\r\n    $rep:=function($study){\r\n      $study.study@$s.\r\n    $s.documentedBy@$sdd.\r\n      $sdd.versions@$sddv.{\"* \"&$sddv.id:\r\n       $sddv.dateValues@$dv.\r\n        $dv.geographicScopes\r\n      {\"** \"&$dv.type.(decode):$join($.(\"*** \"&id & \":\" & type.decode & (code?\" (\" & code.standardCode.decode & \")\")),\"\\n\")}\r\n      ~>$each(function($v,$k){$k&\":\\n\"&$v}) ~> $join(\"\\n\")}\r\n      ~> $merge()~>$each(function($v,$k){$k&\":\\n\"&$v}) ~> $join(\"\\n\")\r\n    };\r\n    \"Positive:\\n\" & $rep($new_study1) & \"\\n\\nNegative:\\n\" & $rep($new_study2)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00182/unit-test-coreid-DDF00182-positive-1.json\");\r\n    $utils.report($rule,$pos_data);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00182/unit-test-coreid-DDF00182-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]