[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/parse_refs.jsonata\")\r\n                 ,$import(\"./utils/sift_tree.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00076/DDF00076.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point and add BC categories        *\r\n    \\***********************************************************************/\r\n\r\n    $old_study := $loadFile(\"./testdata/CDISC_Pilot_Study.json\")\r\n                  ~> |study.versions[0]|\r\n                    {\r\n                        \"bcCategories\":\r\n                            [\r\n                                {\r\n                                    \"id\": \"BiomedicalConceptCategory_1\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"name\": \"BCCAT1\",\r\n                                    \"label\": \"Vital Signs\",\r\n                                    \"memberIds\": \r\n                                        [\r\n                                            \"BiomedicalConcept_22\",\r\n                                            \"BiomedicalConcept_23\",\r\n                                            \"BiomedicalConcept_24\"\r\n                                        ],\r\n                                    \"childIds\": [\"BiomedicalConceptCategory_2\"],\r\n                                    \"notes\": [],\r\n                                    \"instanceType\": \"BiomedicalConceptCategory\"\r\n                                },\r\n                                {\r\n                                    \"id\": \"BiomedicalConceptCategory_2\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"name\": \"BCCAT2\",\r\n                                    \"label\": \"Vital Signs: Heart Rate / Blood Pressure\",\r\n                                    \"memberIds\":\r\n                                        [\r\n                                            \"BiomedicalConcept_16\"\r\n                                        ],\r\n                                    \"childIds\": [\"BiomedicalConceptCategory_3\"],\r\n                                    \"notes\": [],\r\n                                    \"instanceType\": \"BiomedicalConceptCategory\"\r\n                                },\r\n                                {\r\n                                    \"id\": \"BiomedicalConceptCategory_3\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"name\": \"BCCAT3\",\r\n                                    \"label\": \"Vital Signs: Blood Pressure\",\r\n                                    \"memberIds\":\r\n                                        [\r\n                                            \"BiomedicalConcept_14\",\r\n                                            \"BiomedicalConcept_15\"\r\n                                        ],\r\n                                    \"childIds\": [],\r\n                                    \"notes\": [],\r\n                                    \"instanceType\": \"BiomedicalConceptCategory\"\r\n                                },\r\n                                {\r\n                                    \"id\": \"BiomedicalConceptCategory_4\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"name\": \"BCCAT4\",\r\n                                    \"label\": \"Demographics\",\r\n                                    \"memberIds\":\r\n                                        [\r\n                                            \"BiomedicalConcept_20\",\r\n                                            \"BiomedicalConcept_21\"\r\n                                        ],\r\n                                    \"childIds\": [],\r\n                                    \"notes\": [],\r\n                                    \"instanceType\": \"BiomedicalConceptCategory\"\r\n                                }\r\n                            ]\r\n                    }|;\r\n    $old_svid := $old_study.study.versions[0].id;\r\n    $old_sdid := $old_study.study.versions[0].studyDesigns[0].id;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study design, using BC          *\r\n    * categories instead of lists of BCs                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.study.versions[0].studyDesigns[0],$maxids);\r\n    $new_sd := $utils.make_dup($old_study.study.versions[0].studyDesigns[0],$idmap)\r\n                ~> |$|{\"name\": \"Study Design 2\", \"description\": \"A secondary design for the study\"}|\r\n                ~> |activities[id=$lookup($idmap,\"Activity_4\")]|{\"biomedicalConceptIds\": [],\"bcCategoryIds\": [\"BiomedicalConceptCategory_4\"]}|\r\n                ~> |activities[id=$lookup($idmap,\"Activity_13\")]|{\"biomedicalConceptIds\": [],\"bcCategoryIds\": [\"BiomedicalConceptCategory_1\"]}|\r\n                ~> |activities[id=$lookup($idmap,\"Activity_34\")]|{\"biomedicalConceptIds\": [],\"bcCategoryIds\": [\"BiomedicalConceptCategory_2\"]}|\r\n                ~> |activities[id=$lookup($idmap,\"Activity_36\")]|{\"biomedicalConceptIds\": [],\"bcCategoryIds\": [\"BiomedicalConceptCategory_2\"]}|;\r\n    $new_study1 := $old_study\r\n                ~> |study.versions[0]|{\"studyDesigns\": $append(studyDesigns,$new_sd)}|\r\n                ~> |study.versions[0].roles[0]|{\"appliesToIds\": [$old_svid]}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00076/unit-test-coreid-DDF00076-positive.json\",$new_study1);\r\n    \r\n    /***********************************************************************\\\r\n    * Make the following updates in the second study design and then write  *\r\n    * out as negative unit test data:                                       *\r\n    * - Add a direct reference to the sex BC in the activity referencing    *\r\n    *   the Demographics BC category.                                       *\r\n    * - Add a direct reference to the diastolic BP BC in the activity that  *\r\n    *   references the Vital Signs BC category (diastolic BP is referenced  *\r\n    *   in a sub-sub-category).                                             *\r\n    \\***********************************************************************/\r\n    $new_study2 := $new_study1\r\n                    ~> |study.versions[0].studyDesigns[1].activities[id=$lookup($idmap,\"Activity_4\")]|{\"biomedicalConceptIds\": [\"BiomedicalConcept_20\"]}|\r\n                    ~> |study.versions[0].studyDesigns[1].activities[id=$lookup($idmap,\"Activity_13\")]|{\"biomedicalConceptIds\": [\"BiomedicalConcept_15\"]}|;\r\n    $writeFile(\"./rules/DDF00076/unit-test-coreid-DDF00076-negative.json\",$new_study2);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive dataset","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00076/unit-test-coreid-DDF00076-positive.json\");\r\n    $utils.report($rule,$pos_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00076/unit-test-coreid-DDF00076-negative.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]