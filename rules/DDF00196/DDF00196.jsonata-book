[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00196/DDF00196.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $remap:={\r\n              \"NarrativeContent_84\": \"NarrativeContentItem_2\",\r\n              \"NarrativeContent_143\": \"NarrativeContentItem_24\",\r\n              \"NarrativeContent_164\": \"NarrativeContentItem_29\",\r\n              \"NarrativeContent_190\": \"NarrativeContentItem_49\",\r\n              \"NarrativeContent_206\": \"NarrativeContentItem_57\",\r\n              \"NarrativeContent_227\": \"NarrativeContentItem_35\"\r\n            };\r\n\r\n    $new_study1 :=   $loadFile(\"./testdata/CDISC_Pilot_Study.json\")\r\n                    ~> |study.documentedBy.versions.dateValues.type[code=\"C99903x1\"]|{\"code\": \"C71476\",\"decode\":\"Approval Date\"}|\r\n                    ~> |study.documentedBy[1]|{\"name\": \"M11_CDISC PILOT - LZZT\"}|\r\n                    ~> |study.documentedBy[1].versions[0].contents[id in $keys($remap)]|{\"contentItemId\": $lookup($remap,id)}|\r\n                    ~> |study.documentedBy[1].versions[0].contents[id = \"NarrativeContent_84\"]|{\"sectionTitle\": \"Introduction\"}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new enrollment for the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0].changes[0],$maxids);\r\n    $new_ch := $utils.make_dup($new_study1.study.versions[0].amendments[0].changes[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"AMEND_CHG_2\",\r\n                    \"summary\": \"Updated introduction\",\r\n                    \"rationale\": \"It was wrong\"\r\n                  }|\r\n                ~> |changedSections[0]|\r\n                  {\r\n                    \"sectionNumber\": \"1\",\r\n                    \"sectionTitle\": \"Introduction\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0].amendments[0]|{\"changes\": $append(changes,$new_ch)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new enrollment for the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0].changes[1].changedSections[0],$maxids);\r\n    $new_chs := $utils.make_dup($new_study1.study.versions[0].amendments[0].changes[1].changedSections[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"sectionNumber\": \"2\",\r\n                    \"appliesToId\": \"StudyDefinitionDocument_2\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0].amendments[0].changes[1]|{\"changedSections\": $append(changedSections,$new_chs)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new enrollment for the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0].changes[0],$maxids);\r\n    $new_ch := $utils.make_dup($new_study1.study.versions[0].amendments[0].changes[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"AMEND_CHG_3\",\r\n                    \"summary\": \"Another change to section 1.5\",\r\n                    \"rationale\": \"Testing\"\r\n                  }|\r\n                ~> |changedSections[0]|\r\n                  {\r\n                    \"sectionTitle\": \"Section 1.5\",\r\n                    \"appliesToId\": \"StudyDefinitionDocument_2\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0].amendments[0]|{\"changes\": $append(changes,$new_ch)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new enrollment for the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0].changes[1],$maxids);\r\n    $new_ch := $utils.make_dup($new_study1.study.versions[0].amendments[0].changes[1],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"AMEND_CHG_4\",\r\n                    \"summary\": \"Yet another change to section 1.5\",\r\n                    \"rationale\": \"More testing\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0].amendments[0]|{\"changes\": $append(changes,$new_ch)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new copy of the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0],$maxids);\r\n    $new_am := $utils.make_dup($new_study1.study.versions[0].amendments[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"AMEND_2\",\r\n                    \"label\": \"Amendment 2\",\r\n                    \"description\": \"The second amendment\"\r\n                  }|\r\n                ~> |**[sectionTitle=\"Introduction\"]|\r\n                  {\r\n                    \"sectionTitle\": \"INTRODUCTION\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0]|{\"amendments\": $append(amendments,$new_am)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a new copy of the first amendment.           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].amendments[0],$maxids);\r\n    $new_am := $utils.make_dup($new_study1.study.versions[0].amendments[0],$idmap)\r\n                ~> |$|\r\n                  {\r\n                    \"name\": \"AMEND_3\",\r\n                    \"label\": \"Amendment 3\",\r\n                    \"description\": \"The third amendment\"\r\n                  }|\r\n                ~> |**[appliesToId=\"StudyDefinitionDocument_2\"]|\r\n                  {\r\n                    \"appliesToId\": \"StudyDefinitionDocument_xx\"\r\n                  }|;\r\n    $new_study1 :=  $new_study1\r\n                    ~> |study.versions[0]|{\"amendments\": $append(amendments,$new_am)}|;\r\n\r\n    $writeFile(\"./rules/DDF00196/unit-test-coreid-DDF00196-positive-1.json\",$new_study1);\r\n\r\n    $new_study2 :=  $new_study1 ~>\r\n                    |study.versions[0].amendments[0].changes[1].changedSections[1]|\r\n                    {\r\n                      \"appliesToId\": \"StudyDefinitionDocument_1\"\r\n                    }|\r\n                    |study.versions[0].amendments[0].changes[2].changedSections[0]|\r\n                    {\r\n                      \"appliesToId\": \"StudyDefinitionDocument_1\"\r\n                    }|;\r\n\r\n    $writeFile(\"./rules/DDF00196/unit-test-coreid-DDF00196-negative-1.json\",$new_study2);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00196/unit-test-coreid-DDF00196-positive-1.json\");\r\n    $utils.report($rule,$pos_data);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00196/unit-test-coreid-DDF00196-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]