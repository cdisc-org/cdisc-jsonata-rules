Authorities:
  - Organization: CDISC
    Standards:
      - Name: USDM
        References:
          - Citations:
              - Cited Guidance: 'Referenced id values must be valid according to the USDM schema
                  based on the API specification.'
                Document: 'USDM_CORE_Rules.xlsx'
            Origin: 'USDM Conformance Rules'
            Rule Identifier:
              Id: 'DDF00262'
              Version: '1'
            Version: '1.0'
        Version: '4.0'
Check: |-
  (
    $idl := **[id and instanceType]{id:$distinct(instanceType)};
    $valid_entities := 
      {
        "Activity.biomedicalConceptIds": [
            "BiomedicalConcept"
        ],
        "Activity.nextId": [
            "Activity"
        ],
        "Activity.timelineId": [
            "ScheduleTimeline"
        ],
        "Activity.childIds": [
            "Activity"
        ],
        "Activity.previousId": [
            "Activity"
        ],
        "Activity.bcSurrogateIds": [
            "BiomedicalConceptSurrogate"
        ],
        "Activity.bcCategoryIds": [
            "BiomedicalConceptCategory"
        ],
        "AdministrableProductIdentifier.scopeId": [
            "Organization"
        ],
        "Administration.administrableProductId": [
            "AdministrableProduct"
        ],
        "Administration.medicalDeviceId": [
            "MedicalDevice"
        ],
        "AnalysisPopulation.subsetOfIds": [
            "StudyCohort",
            "StudyDesignPopulation"
        ],
        "AssignedPerson.organizationId": [
            "Organization"
        ],
        "BiomedicalConceptCategory.memberIds": [
            "BiomedicalConcept"
        ],
        "BiomedicalConceptCategory.childIds": [
            "BiomedicalConceptCategory"
        ],
        "Characteristic.dictionaryId": [
            "SyntaxTemplateDictionary"
        ],
        "Condition.dictionaryId": [
            "SyntaxTemplateDictionary"
        ],
        "Condition.contextIds": [
            "Activity",
            "ScheduledActivityInstance"
        ],
        "Condition.appliesToIds": [
            "BiomedicalConceptCategory",
            "Procedure",
            "Activity",
            "BiomedicalConcept",
            "BiomedicalConceptSurrogate"
        ],
        "ConditionAssignment.conditionTargetId": [
            "ScheduledActivityInstance",
            "ScheduledDecisionInstance"
        ],
        "DocumentContentReference.appliesToId": [
            "StudyDefinitionDocument"
        ],
        "EligibilityCriterion.criterionItemId": [
            "EligibilityCriterionItem"
        ],
        "EligibilityCriterion.nextId": [
            "EligibilityCriterion"
        ],
        "EligibilityCriterion.previousId": [
            "EligibilityCriterion"
        ],
        "EligibilityCriterionItem.dictionaryId": [
            "SyntaxTemplateDictionary"
        ],
        "Encounter.nextId": [
            "Encounter"
        ],
        "Encounter.scheduledAtId": [
            "Timing"
        ],
        "Encounter.previousId": [
            "Encounter"
        ],
        "Endpoint.dictionaryId": [
            "SyntaxTemplateDictionary"
        ],
        "Estimand.analysisPopulationId": [
            "AnalysisPopulation"
        ],
        "Estimand.variableOfInterestId": [
            "Endpoint"
        ],
        "Estimand.interventionIds": [
            "StudyIntervention"
        ],
        "Identifier.scopeId": [
            "Organization"
        ],
        "IntercurrentEvent.dictionaryId": [
            "SyntaxTemplateDictionary"
        ],
        "InterventionalStudyDesign.documentVersionIds": [
            "StudyDefinitionDocumentVersion"
        ],
        "InterventionalStudyDesign.studyInterventionIds": [
            "StudyIntervention"
        ],
        "MedicalDevice.embeddedProductId": [
            "AdministrableProduct"
        ],
        "MedicalDeviceIdentifier.scopeId": [
            "Organization"
        ],
        "NarrativeContent.contentItemId": [
            "NarrativeContentItem"
        ],
        "NarrativeContent.previousId": [
            "NarrativeContent"
        ],
        "NarrativeContent.nextId": [
            "NarrativeContent"
        ],
        "NarrativeContent.childIds": [
            "NarrativeContent"
        ],
        "Objective.dictionaryId": [
            "SyntaxTemplateDictionary"
        ],
        "ObservationalStudyDesign.documentVersionIds": [
            "StudyDefinitionDocumentVersion"
        ],
        "ObservationalStudyDesign.studyInterventionIds": [
            "StudyIntervention"
        ],
        "PopulationDefinition.criterionIds": [
            "EligibilityCriterion"
        ],
        "Procedure.studyInterventionId": [
            "StudyIntervention"
        ],
        "ProductOrganizationRole.appliesToIds": [
            "AdministrableProduct",
            "MedicalDevice"
        ],
        "ProductOrganizationRole.organizationId": [
            "Organization"
        ],
        "ReferenceIdentifier.scopeId": [
            "Organization"
        ],
        "ScheduleTimeline.entryId": [
            "ScheduledActivityInstance",
            "ScheduledDecisionInstance"
        ],
        "ScheduledActivityInstance.defaultConditionId": [
            "ScheduledActivityInstance",
            "ScheduledDecisionInstance"
        ],
        "ScheduledActivityInstance.epochId": [
            "StudyEpoch"
        ],
        "ScheduledActivityInstance.activityIds": [
            "Activity"
        ],
        "ScheduledActivityInstance.encounterId": [
            "Encounter"
        ],
        "ScheduledActivityInstance.timelineId": [
            "ScheduleTimeline"
        ],
        "ScheduledActivityInstance.timelineExitId": [
            "ScheduleTimelineExit"
        ],
        "ScheduledDecisionInstance.defaultConditionId": [
            "ScheduledActivityInstance",
            "ScheduledDecisionInstance"
        ],
        "ScheduledDecisionInstance.epochId": [
            "StudyEpoch"
        ],
        "ScheduledInstance.defaultConditionId": [
            "ScheduledActivityInstance",
            "ScheduledDecisionInstance"
        ],
        "ScheduledInstance.epochId": [
            "StudyEpoch"
        ],
        "StudyAmendment.previousId": [
            "StudyAmendment"
        ],
        "StudyArm.populationIds": [
            "StudyCohort",
            "StudyDesignPopulation"
        ],
        "StudyCell.armId": [
            "StudyArm"
        ],
        "StudyCell.epochId": [
            "StudyEpoch"
        ],
        "StudyCell.elementIds": [
            "StudyElement"
        ],
        "StudyCohort.criterionIds": [
            "EligibilityCriterion"
        ],
        "StudyCohort.indicationIds": [
            "Indication"
        ],
        "StudyDefinitionDocument.childIds": [
            "StudyDefinitionDocument"
        ],
        "StudyDesign.documentVersionIds": [
            "StudyDefinitionDocumentVersion"
        ],
        "StudyDesign.studyInterventionIds": [
            "StudyIntervention"
        ],
        "StudyDesignPopulation.criterionIds": [
            "EligibilityCriterion"
        ],
        "StudyElement.studyInterventionIds": [
            "StudyIntervention"
        ],
        "StudyEpoch.previousId": [
            "StudyEpoch"
        ],
        "StudyEpoch.nextId": [
            "StudyEpoch"
        ],
        "StudyIdentifier.scopeId": [
            "Organization"
        ],
        "StudyRole.organizationIds": [
            "Organization"
        ],
        "StudyRole.appliesToIds": [
            "StudyVersion",
            "InterventionalStudyDesign",
            "ObservationalStudyDesign"
        ],
        "StudyVersion.documentVersionIds": [
            "StudyDefinitionDocumentVersion"
        ],
        "SubjectEnrollment.forStudyCohortId": [
            "StudyCohort"
        ],
        "SubjectEnrollment.forStudySiteId": [
            "StudySite"
        ],
        "SyntaxTemplate.dictionaryId": [
            "SyntaxTemplateDictionary"
        ],
        "Timing.relativeToScheduledInstanceId": [
            "ScheduledActivityInstance",
            "ScheduledDecisionInstance"
        ],
        "Timing.relativeFromScheduledInstanceId": [
            "ScheduledActivityInstance",
            "ScheduledDecisionInstance"
        ]
      };
  **[instanceType] ~>
    $map(function($v)
      {
        $keys($v)[$ ~> /^[a-zA-Z]+Id(s)?$/].
          (
            $idattr:=$;
            $idfattr:=$join([$v.instanceType,$],".");
            $refids:=$lookup($v,$);
            $refids 
            ? $refids.
                {   
                  "instanceType": $v.instanceType,
                  "id": $v.id,
                  "path": $v._path,
                  "Id Attribute": $idattr,
                  "Id Value": $,
                  "Issue": 
                    $ in $keys($idl)
                    ? (
                        $ent4id := $lookup($idl,$);
                        $idfattr in $keys($valid_entities)
                        ? (
                            $ents4att := $lookup($valid_entities,$idfattr);
                            $ent4id in $ents4att
                            ? null
                            : "Invalid entity [" & $ent4id & " not " &
                              (   $count($ents4att) = 1
                                  ? "a " & $ents4att[0] 
                                  : "any of " & $join($ents4att,", ")
                              ) & "]"
                          )
                        : null
                      )
                    : "Invalid id"                                    
                }[Issue]
          )
      }
    ) ~> $reduce($append)
  )
Core:
  Id: 'DDF00262'
  Status: Draft
  Version: '1'
Description: 'Referenced id values must be valid according to the USDM schema
  based on the API specification.'
Executability: Fully Executable
Outcome:
  Message: 'The referenced id value is not valid - the id value doesn''t match any
    object or the id value refers to an instance of an incorrect entity.'
  Output Variables:
    - 'Id Attribute'
    - 'Id Value'
    - Issue
Rule Type: JSONata
Scope:
  Entities:
    Include:
      - 'ALL'
Sensitivity: Record
