{
    "rule": {
        "Authorities": [
            {
                "Organization": "CDISC",
                "Standards": [
                    {
                        "Name": "USDM",
                        "References": [
                            {
                                "Citations": [
                                    {
                                        "Document": "USDM_CORE_Rules.xlsx",
                                        "Cited_Guidance": "Referenced id values must be valid according to the USDM schema based on the API specification."
                                    }
                                ],
                                "Origin": "USDM Conformance Rules",
                                "Version": "1.0",
                                "Rule_Identifier": {
                                    "Id": "DDF00262",
                                    "Version": "1"
                                }
                            }
                        ],
                        "Version": "4.0"
                    }
                ]
            }
        ],
        "Check": "(\n    $idl := **[id and instanceType]{id:$distinct(instanceType)};\n    $valid_entities := \n        {\n            \"Activity.biomedicalConceptIds\": [\n                \"BiomedicalConcept\"\n            ],\n            \"Activity.nextId\": [\n                \"Activity\"\n            ],\n            \"Activity.timelineId\": [\n                \"ScheduleTimeline\"\n            ],\n            \"Activity.childIds\": [\n                \"Activity\"\n            ],\n            \"Activity.previousId\": [\n                \"Activity\"\n            ],\n            \"Activity.bcSurrogateIds\": [\n                \"BiomedicalConceptSurrogate\"\n            ],\n            \"Activity.bcCategoryIds\": [\n                \"BiomedicalConceptCategory\"\n            ],\n            \"AdministrableProductIdentifier.scopeId\": [\n                \"Organization\"\n            ],\n            \"Administration.administrableProductId\": [\n                \"AdministrableProduct\"\n            ],\n            \"Administration.medicalDeviceId\": [\n                \"MedicalDevice\"\n            ],\n            \"AnalysisPopulation.subsetOfIds\": [\n                \"StudyCohort\",\n                \"StudyDesignPopulation\"\n            ],\n            \"AssignedPerson.organizationId\": [\n                \"Organization\"\n            ],\n            \"BiomedicalConceptCategory.memberIds\": [\n                \"BiomedicalConcept\"\n            ],\n            \"BiomedicalConceptCategory.childIds\": [\n                \"BiomedicalConceptCategory\"\n            ],\n            \"Characteristic.dictionaryId\": [\n                \"SyntaxTemplateDictionary\"\n            ],\n            \"Condition.dictionaryId\": [\n                \"SyntaxTemplateDictionary\"\n            ],\n            \"Condition.contextIds\": [\n                \"Activity\",\n                \"ScheduledActivityInstance\"\n            ],\n            \"Condition.appliesToIds\": [\n                \"BiomedicalConceptCategory\",\n                \"Procedure\",\n                \"Activity\",\n                \"BiomedicalConcept\",\n                \"BiomedicalConceptSurrogate\"\n            ],\n            \"ConditionAssignment.conditionTargetId\": [\n                \"ScheduledActivityInstance\",\n                \"ScheduledDecisionInstance\"\n            ],\n            \"DocumentContentReference.appliesToId\": [\n                \"StudyDefinitionDocument\"\n            ],\n            \"EligibilityCriterion.criterionItemId\": [\n                \"EligibilityCriterionItem\"\n            ],\n            \"EligibilityCriterion.nextId\": [\n                \"EligibilityCriterion\"\n            ],\n            \"EligibilityCriterion.previousId\": [\n                \"EligibilityCriterion\"\n            ],\n            \"EligibilityCriterionItem.dictionaryId\": [\n                \"SyntaxTemplateDictionary\"\n            ],\n            \"Encounter.nextId\": [\n                \"Encounter\"\n            ],\n            \"Encounter.scheduledAtId\": [\n                \"Timing\"\n            ],\n            \"Encounter.previousId\": [\n                \"Encounter\"\n            ],\n            \"Endpoint.dictionaryId\": [\n                \"SyntaxTemplateDictionary\"\n            ],\n            \"Estimand.analysisPopulationId\": [\n                \"AnalysisPopulation\"\n            ],\n            \"Estimand.variableOfInterestId\": [\n                \"Endpoint\"\n            ],\n            \"Estimand.interventionIds\": [\n                \"StudyIntervention\"\n            ],\n            \"Identifier.scopeId\": [\n                \"Organization\"\n            ],\n            \"IntercurrentEvent.dictionaryId\": [\n                \"SyntaxTemplateDictionary\"\n            ],\n            \"InterventionalStudyDesign.documentVersionIds\": [\n                \"StudyDefinitionDocumentVersion\"\n            ],\n            \"InterventionalStudyDesign.studyInterventionIds\": [\n                \"StudyIntervention\"\n            ],\n            \"MedicalDevice.embeddedProductId\": [\n                \"AdministrableProduct\"\n            ],\n            \"MedicalDeviceIdentifier.scopeId\": [\n                \"Organization\"\n            ],\n            \"NarrativeContent.contentItemId\": [\n                \"NarrativeContentItem\"\n            ],\n            \"NarrativeContent.previousId\": [\n                \"NarrativeContent\"\n            ],\n            \"NarrativeContent.nextId\": [\n                \"NarrativeContent\"\n            ],\n            \"NarrativeContent.childIds\": [\n                \"NarrativeContent\"\n            ],\n            \"Objective.dictionaryId\": [\n                \"SyntaxTemplateDictionary\"\n            ],\n            \"ObservationalStudyDesign.documentVersionIds\": [\n                \"StudyDefinitionDocumentVersion\"\n            ],\n            \"ObservationalStudyDesign.studyInterventionIds\": [\n                \"StudyIntervention\"\n            ],\n            \"PopulationDefinition.criterionIds\": [\n                \"EligibilityCriterion\"\n            ],\n            \"Procedure.studyInterventionId\": [\n                \"StudyIntervention\"\n            ],\n            \"ProductOrganizationRole.appliesToIds\": [\n                \"AdministrableProduct\",\n                \"MedicalDevice\"\n            ],\n            \"ProductOrganizationRole.organizationId\": [\n                \"Organization\"\n            ],\n            \"ReferenceIdentifier.scopeId\": [\n                \"Organization\"\n            ],\n            \"ScheduleTimeline.entryId\": [\n                \"ScheduledActivityInstance\",\n                \"ScheduledDecisionInstance\"\n            ],\n            \"ScheduledActivityInstance.defaultConditionId\": [\n                \"ScheduledActivityInstance\",\n                \"ScheduledDecisionInstance\"\n            ],\n            \"ScheduledActivityInstance.epochId\": [\n                \"StudyEpoch\"\n            ],\n            \"ScheduledActivityInstance.activityIds\": [\n                \"Activity\"\n            ],\n            \"ScheduledActivityInstance.encounterId\": [\n                \"Encounter\"\n            ],\n            \"ScheduledActivityInstance.timelineId\": [\n                \"ScheduleTimeline\"\n            ],\n            \"ScheduledActivityInstance.timelineExitId\": [\n                \"ScheduleTimelineExit\"\n            ],\n            \"ScheduledDecisionInstance.defaultConditionId\": [\n                \"ScheduledActivityInstance\",\n                \"ScheduledDecisionInstance\"\n            ],\n            \"ScheduledDecisionInstance.epochId\": [\n                \"StudyEpoch\"\n            ],\n            \"ScheduledInstance.defaultConditionId\": [\n                \"ScheduledActivityInstance\",\n                \"ScheduledDecisionInstance\"\n            ],\n            \"ScheduledInstance.epochId\": [\n                \"StudyEpoch\"\n            ],\n            \"StudyAmendment.previousId\": [\n                \"StudyAmendment\"\n            ],\n            \"StudyArm.populationIds\": [\n                \"StudyCohort\",\n                \"StudyDesignPopulation\"\n            ],\n            \"StudyCell.armId\": [\n                \"StudyArm\"\n            ],\n            \"StudyCell.epochId\": [\n                \"StudyEpoch\"\n            ],\n            \"StudyCell.elementIds\": [\n                \"StudyElement\"\n            ],\n            \"StudyCohort.criterionIds\": [\n                \"EligibilityCriterion\"\n            ],\n            \"StudyCohort.indicationIds\": [\n                \"Indication\"\n            ],\n            \"StudyDefinitionDocument.childIds\": [\n                \"StudyDefinitionDocument\"\n            ],\n            \"StudyDesign.documentVersionIds\": [\n                \"StudyDefinitionDocumentVersion\"\n            ],\n            \"StudyDesign.studyInterventionIds\": [\n                \"StudyIntervention\"\n            ],\n            \"StudyDesignPopulation.criterionIds\": [\n                \"EligibilityCriterion\"\n            ],\n            \"StudyElement.studyInterventionIds\": [\n                \"StudyIntervention\"\n            ],\n            \"StudyEpoch.previousId\": [\n                \"StudyEpoch\"\n            ],\n            \"StudyEpoch.nextId\": [\n                \"StudyEpoch\"\n            ],\n            \"StudyIdentifier.scopeId\": [\n                \"Organization\"\n            ],\n            \"StudyRole.organizationIds\": [\n                \"Organization\"\n            ],\n            \"StudyRole.appliesToIds\": [\n                \"StudyVersion\",\n                \"InterventionalStudyDesign\",\n                \"ObservationalStudyDesign\"\n            ],\n            \"StudyVersion.documentVersionIds\": [\n                \"StudyDefinitionDocumentVersion\"\n            ],\n            \"SubjectEnrollment.forStudyCohortId\": [\n                \"StudyCohort\"\n            ],\n            \"SubjectEnrollment.forStudySiteId\": [\n                \"StudySite\"\n            ],\n            \"SyntaxTemplate.dictionaryId\": [\n                \"SyntaxTemplateDictionary\"\n            ],\n            \"Timing.relativeToScheduledInstanceId\": [\n                \"ScheduledActivityInstance\",\n                \"ScheduledDecisionInstance\"\n            ],\n            \"Timing.relativeFromScheduledInstanceId\": [\n                \"ScheduledActivityInstance\",\n                \"ScheduledDecisionInstance\"\n            ]\n        };\n    **[instanceType] ~>\n    $map(function($v)\n        {\n            $keys($v)[$ ~> /^[a-zA-Z]+Id(s)?$/].\n                (\n                    $idattr:=$;\n                    $idfattr:=$join([$v.instanceType,$],\".\");\n                    $refids:=$lookup($v,$);\n                    $refids \n                    ?   $refids.\n                            {   \n                                \"instanceType\": $v.instanceType,\n                                \"id\": $v.id,\n                                \"path\": $v._path,\n                                \"Id Attribute\": $idattr,\n                                \"Id Value\": $,\n                                \"Issue\": \n                                    $ in $keys($idl)\n                                    ?   (\n                                            $ent4id := $lookup($idl,$);\n                                            $idfattr in $keys($valid_entities)\n                                            ?   (\n                                                    $ents4att := $lookup($valid_entities,$idfattr);\n                                                    $ent4id in $ents4att\n                                                    ? null\n                                                    : \"Invalid entity [\" & $ent4id & \" not \" &\n                                                        (   $count($ents4att) = 1\n                                                            ? \"a \" & $ents4att[0] \n                                                            : \"any of \" & $join($ents4att,\", \")\n                                                        ) & \"]\"\n                                                )\n                                            : null\n                                        )\n                                    : \"Invalid id\"                                    \n                            }[Issue]\n                )\n        }\n    )\n)",
        "Core": {
            "Id": "",
            "Status": "Draft",
            "Version": "1"
        },
        "Description": "Referenced id values must be valid according to the USDM schema based on the API specification.",
        "Executability": "Fully Executable",
        "Outcome": {
            "Message": "The referenced id value is not valid - the id value doesn't match any object or the id value refers to an instance of an incorrect entity.",
            "Output_Variables": [
                "Id Attribute",
                "Id Value",
                "Issue"
            ]
        },
        "Scope": {
            "Entities": {
                "Include": [
                    "ALL"
                ]
            }
        },
        "Sensitivity": "Record",
        "Rule_Type": "JSONata"
    },
    "datasets": [],
    "codelists": []
}