[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00172/DDF00172.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $old_study := $loadFile(\"./testdata/CDISC_Pilot_Study.json\");\r\n    $old_svid := $old_study.study.versions[0].id;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first role, changing to laboratory    *\r\n    * and applying to the study version.                                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.study.versions[0].roles[0],$maxids);\r\n    $new_role := $utils.make_dup($old_study.study.versions[0].roles[0],$idmap)\r\n                ~> |$|\r\n                    {\r\n                        \"name\": \"ROLE_2\",\r\n                        \"label\": \"Laboratory\",\r\n                        \"appliesToIds\": [$old_svid],\r\n                        \"organizationIds\": [\"Organization_3\"]\r\n                    },[\"masking\"]|\r\n                ~> |code|{\"code\": \"C37984\", \"decode\": \"Laboratory\"}|;\r\n    $new_study := $old_study ~> |study.versions[0]|{\"roles\": $append(roles,$new_role)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first organization                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study);\r\n    $idmap := $utils.get_idmap($new_study.study.versions[0].organizations[0],$maxids);\r\n    $new_org := $utils.make_dup($new_study.study.versions[0].organizations[0],$idmap) ~> |$|{\"name\": \"LILLY2\"}|;\r\n    $new_study1 := $new_study ~> |study.versions[0]|{\"organizations\": $append(organizations,$new_org)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study identifier                *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($new_study1.study.versions[0].studyIdentifiers[0],$maxids);\r\n    $new_stid := $utils.make_dup($new_study1.study.versions[0].studyIdentifiers[0],$idmap) ~> |$|{\"text\": \"H2Q-MC-LZZT-2\", \"scopeId\": $new_org.id}|;\r\n    $new_study2 := $new_study1 ~> |study.versions[0]|{\"studyIdentifiers\": $append(studyIdentifiers,$new_stid)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-positive-1.json\",$new_study2);\r\n    \r\n    /***********************************************************************\\\r\n    * Remove all organizations from the list of organizations for the study *\r\n    * sponsor role and write out as negative unit test data.                *\r\n    \\***********************************************************************/\r\n    $new_study3 := $new_study2 ~> |study.versions[0].roles[code.code=\"C70793\"]|{\"organizationIds\": []}|;\r\n    $writeFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-negative-1.json\",$new_study3);\r\n\r\n    /***********************************************************************\\\r\n    * Add the id for the new organization to the list of organizations for  *\r\n    * the study sponsor role and write out as negative unit test data.      *\r\n    \\***********************************************************************/\r\n    $new_study4 := $new_study2 ~> |study.versions[0].roles[code.code=\"C70793\"]|{\"organizationIds\": $append(organizationIds,$new_org.id)}|;\r\n    $writeFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-negative-2.json\",$new_study4);\r\n\r\n    /***********************************************************************\\\r\n    * Change the scope of the second study identifier to be the same as the *\r\n    * first study identifier and write out as negative unit test data.      *\r\n    \\***********************************************************************/\r\n    $new_study5 := $new_study2 ~> |study.versions[0].studyIdentifiers[id=$new_stid.id]|{\"scopeId\": $old_study.study.versions[0].organizations[0].id}|;\r\n    $writeFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-negative-3.json\",$new_study5);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-positive-1.json\");\r\n    $utils.report($rule,$pos_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data (no sponsor ids)","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data (>1 sponsor ids - 1 id each for 2 sponsor orgs)","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-negative-2.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data (>1 sponsor ids - 2 ids for 1 sponsor org)","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00172/unit-test-coreid-DDF00172-negative-3.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]