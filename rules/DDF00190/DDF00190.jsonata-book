[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00190/DDF00190.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $old_study := $loadFile(\"./testdata/CDISC_Pilot_Study.json\");\r\n    $old_svid := $old_study.study.versions[0].id;\r\n    $old_sdid := $old_study.study.versions[0].studyDesigns[0].id;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first role, changing to study subject *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.study.versions[0].roles[0],$maxids);\r\n    $new_role1 := $utils.make_dup($old_study.study.versions[0].roles[0],$idmap)\r\n                ~> |$|\r\n                    {\r\n                        \"name\": \"ROLE_2\",\r\n                        \"label\": \"Investigator\",\r\n                        \"appliesToIds\": [$old_sdid,$new_sd1.id],\r\n                        \"organizationIds\": [],\r\n                        \"assignedPersons\": [\r\n                            {\r\n                                \"id\": \"AssignedPerson_1\",\r\n                                \"name\": \"AP1\",\r\n                                \"personName\": {\r\n                                    \"id\": \"PersonName_1\",\r\n                                    \"text\": \"Dr. Jane Jones\",\r\n                                    \"familyName\": \"Jones\",\r\n                                    \"givenNames\": [\"Jane\"],\r\n                                    \"prefixes\": [\"Dr.\"],\r\n                                    \"suffixes\": [\"MBChB\"],\r\n                                    \"instanceType\": \"PersonName\"\r\n                                },\r\n                                \"jobTitle\": \"Senior Consultant\",\r\n                                \"organizationId\": \"Organization_3\",\r\n                                \"instanceType\": \"AssignedPerson\"\r\n                            },\r\n                            {\r\n                                \"id\": \"AssignedPerson_2\",\r\n                                \"name\": \"AP2\",\r\n                                \"personName\": {\r\n                                    \"id\": \"PersonName_2\",\r\n                                    \"text\": \"Dr. John Smith\",\r\n                                    \"familyName\": \"Smith\",\r\n                                    \"givenNames\": [\"John\"],\r\n                                    \"prefixes\": [\"Dr.\"],\r\n                                    \"suffixes\": [],\r\n                                    \"instanceType\": \"PersonName\"\r\n                                },\r\n                                \"jobTitle\": \"General Practitioner\",\r\n                                \"organizationId\": null,\r\n                                \"instanceType\": \"AssignedPerson\"\r\n                            }\r\n                        ]\r\n                    }|\r\n                ~> |code|{\"code\": \"C25936\", \"decode\": \"Investigator\"}|;\r\n    $new_study2 := $old_study ~> |study.versions[0]|{\"roles\": $append(roles,$new_role1)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first role, changing to sponsor       *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study2);\r\n    $idmap := $utils.get_idmap($new_study2.study.versions[0].roles[0],$maxids);\r\n    $new_role2 := $utils.make_dup($new_study2.study.versions[0].roles[0],$idmap)\r\n                ~> |$|\r\n                    {\r\n                        \"name\": \"ROLE_3\",\r\n                        \"label\": \"Local Sponsor\",\r\n                        \"appliesToIds\": [$new_sd2.id],\r\n                        \"organizationIds\": [\"Organization_3\"]                        \r\n                    }|\r\n                ~> |code|{\"code\": \"C215670\", \"decode\": \"Local Sponsor\"}|;\r\n    $new_study3 := $new_study2 ~> |study.versions[0]|{\"roles\": $append(roles,$new_role2)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00190/unit-test-coreid-DDF00190-positive-1.json\",$new_study3);\r\n    \r\n    /***********************************************************************\\\r\n    * Create a copy of the second role's first assigned person              *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study3);\r\n    $idmap := $utils.get_idmap($new_study3.study.versions[0].roles[1].assignedPersons[0],$maxids);\r\n    $new_ap1 := $utils.make_dup($new_study3.study.versions[0].roles[1].assignedPersons[0],$idmap)\r\n                ~> |$|{\"name\": \"AP3\"}|;\r\n\r\n    /***********************************************************************\\\r\n    * Make the following updates then write out as negative unit test data: *\r\n    * - Add the copy of the first assigned person from the second role to   *\r\n    *   the third role.                                                     *\r\n    \\***********************************************************************/\r\n    $old_orgid:=$old_study.study.versions[0].roles[0].organizationIds[0];\r\n    $new_study4 := $new_study3\r\n                    ~> |study.versions[0].roles[1]|{\"organizationIds\": [$old_orgid,\"Organization_xx\"]}|\r\n                    ~> |study.versions[0].roles[2]|{\"assignedPersons\": [$new_ap1]}|;\r\n    $writeFile(\"./rules/DDF00190/unit-test-coreid-DDF00190-negative-1.json\",$new_study4)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00190/unit-test-coreid-DDF00190-positive-1.json\");\r\n    $utils.report($rule,$pos_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00190/unit-test-coreid-DDF00190-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]