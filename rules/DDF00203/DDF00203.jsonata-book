[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00203/DDF00203.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $old_study := $loadFile(\"./testdata/CDISC_Pilot_Study.json\");\r\n    $old_svid := $old_study.study.versions[0].id;\r\n    $old_sdid := $old_study.study.versions[0].studyDesigns[0].id;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study design and make the study *\r\n    * role apply to the study version (all study designs).                  *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.study.versions[0].studyDesigns[0],$maxids);\r\n    $new_sd1 := $utils.make_dup($old_study.study.versions[0].studyDesigns[0],$idmap)\r\n                ~> |$|{\"name\": \"Study Design 2\", \"description\": \"A secondary design for the study\"}|;\r\n    $new_study1a := $old_study\r\n                ~> |study.versions[0]|{\"studyDesigns\": $append(studyDesigns,$new_sd1)}|\r\n                ~> |study.versions[0].roles[0]|{\"appliesToIds\": [$old_svid]}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first role, changing to study subject *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1a);\r\n    $idmap := $utils.get_idmap($new_study1a.study.versions[0].roles[0],$maxids);\r\n    $new_role1 := $utils.make_dup($new_study1a.study.versions[0].roles[0],$idmap)\r\n                ~> |$|{\"name\": \"ROLE_2\", \"label\": \"Subject\", \"appliesToIds\": [$old_sdid,$new_sd1.id]}|\r\n                ~> |code|{\"code\": \"C41189\", \"decode\": \"Study Subject\"}|;\r\n    $new_study2 := $new_study1a ~> |study.versions[0]|{\"roles\": $append(roles,$new_role1)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first role, changing to sponsor       *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study2);\r\n    $idmap := $utils.get_idmap($new_study2.study.versions[0].roles[0],$maxids);\r\n    $new_role2 := $utils.make_dup($new_study2.study.versions[0].roles[0],$idmap)\r\n                ~> |$|{\"name\": \"ROLE_3\", \"label\": \"Investigator\", \"appliesToIds\": [$new_sd1.id]}|\r\n                ~> |code|{\"code\": \"C25936\", \"decode\": \"Investigator\"}|;\r\n    $new_study3 := $new_study2 ~> |study.versions[0]|{\"roles\": $append(roles,$new_role2)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-positive-1.json\",$new_study3);\r\n    \r\n    /***********************************************************************\\\r\n    * Make the following updates then write out as positive unit test data: *\r\n    * - Make the first role apply to both the study version and the second  *\r\n    *   study design (this would fail DDF00189 but is OK here).             *\r\n    \\***********************************************************************/\r\n    $new_study4 := $new_study3\r\n                    ~> |study.versions[0].roles[0]|{\"appliesToIds\": $append(appliesToIds, $new_sd1.id)}|;\r\n    $writeFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-positive-2.json\",$new_study4);\r\n\r\n    /***********************************************************************\\\r\n    * Make the following updates then write out as negative unit test data: *\r\n    * - Make the first role apply to nothing.\r\n    \\***********************************************************************/\r\n    $new_study5 := $new_study3\r\n                    ~> |study.versions[0].roles[0]|{\"appliesToIds\": []}|;\r\n    $writeFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-negative-1.json\",$new_study5);\r\n\r\n    /***********************************************************************\\\r\n    * Make the following updates then write out as negative unit test data: *\r\n    * - Make the first role apply to both study designs.                    *\r\n    \\***********************************************************************/\r\n    $new_study5 := $new_study3\r\n                    ~> |study.versions[0].roles[0]|{\"appliesToIds\": [$old_sdid,$new_sd1.id]}|;\r\n    $writeFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-negative-2.json\",$new_study5);\r\n\r\n    /***********************************************************************\\\r\n    * Make the following updates then write out as negative unit test data: *\r\n    * - Make the first role apply to an invalid id.                         *\r\n    \\***********************************************************************/\r\n    $new_study6 := $new_study3\r\n                    ~> |study.versions[0].roles[0]|{\"appliesToIds\": [\"StudyVersion_xxx\"]}|;\r\n    $writeFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-negative-3.json\",$new_study6);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data - sponsor role applies to only study version","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-positive-1.json\");\r\n    $utils.report($rule,$pos_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data - sponsor role applies to study version and study id","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-positive-2.json\");\r\n    $utils.report($rule,$pos_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data - sponsor role applies to nothing","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data - sponsor role applies to study designs","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-negative-2.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data - sponsor role applies to invalid id","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00203/unit-test-coreid-DDF00203-negative-3.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]