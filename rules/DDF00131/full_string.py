full_string = '(\n$utils:={\n\n    /* \n        Delete repeated sequential elements from an array.\n        - Input:  [1, 1, 2, 2, 2, 1, 3, 3]\n        - Output: [1, 2, 1, 3]\n    */\n    "del_reps": function($lst)\n                    {\n                        $lst ~> $filter(function($v,$i,$a){$i = 0 or ($i > 0 and $v != $a[$i-1])})\n                    }\n,\n\n    "get_idmap" : function($obj,$mxids)\n                    {\n                        $reduce(\n                            ($obj.**[id]).\n                                {\n                                    "id": id, \n                                    "instanceType": instanceType\n                                },\n                            function($idx,$v)\n                                {\n                                    (\n                                        $nxt := $v.instanceType in $keys($idx) ? $lookup($idx,$v.instanceType).next + 1 : 1;\n                                        $idx := $idx ~> |$|\n                                            {\n                                                $v.instanceType: \n                                                    {\n                                                        "max": $lookup($idx,$v.instanceType).max,\n                                                        "next": $nxt,\n                                                        "ids": $append(\n                                                                $lookup($idx,$v.instanceType).ids, \n                                                                {\n                                                                    "old": $v.id,\n                                                                    "new": $join([$v.instanceType,$string($nxt)],"_")\n                                                                }\n                                                            )\n                                                    }\n                                            }| ;\n                                    \n                                    )\n                                },\n                            $mxids\n                        ).**.${old: new}\n                    }\n,\n\n    "get_maxids" : function($wrapper)\n                    {\n                        $wrapper.(**[id]).$\n                            {\n                                instanceType: $.["max","next"]@$k\n                                    {\n                                        $k: $max($.$number($substringAfter($string(id),"_")))\n                                    }\n                            }\n                    }\n,\n\n    "get_path": function($tgtobj,$within)\n                    {\n                        (\n                            $pref := function($this, $parent)\n                                        {\n                                            (\n                                                $pa := $filter($keys($parent),\n                                                            function($k)\n                                                            {\n                                                                (\n                                                                    $v := $lookup($parent,$k);\n                                                                    $type($v) = "array" ? $this in $v : $v = $this\n                                                                )\n                                                            }\n                                                        );\n                                                $pav := $lookup($parent,$pa);\n                                                $type($pav) = "array"\n                                                ?   $map(\n                                                        $pav,\n                                                        function($av,$ai)\n                                                            {\n                                                                $av=$this ? $ak := $pa & "[" & $ai & "]"\n                                                            }\n                                                    )\n                                                : $pa\n                                            )\n                                        };\n                            $iter := function($t,$acc,$cnt)\n                                        {\n                                            (\n                                                $t = $within or $cnt > 20\n                                                ? $acc\n                                                : \n                                                    (\n                                                        $p := $within.**.*[$=$t].%;\n                                                        $pa := $pref($t,$p);\n                                                        $iter($p,$append([$pa],$acc),$cnt + 1)\n                                                    )\n                                            )\n                                        };\n                            $iter($tgtobj,[],1) ~> $join(".")\n                        )\n                    }\n,\n\n    "get_ref_value": function($usdm_ref,$within,$not_found_value)\n                        {\n                            (\n                                $found_obj := $within.**\n                                                        [\n                                                            id=$usdm_ref.id and\n                                                            instanceType=$usdm_ref.klass and\n                                                            $usdm_ref.attribute in $keys($)\n                                                        ];\n                                $found_obj \n                                ? $found_obj.$lookup($,$usdm_ref.attribute)\n                                : $not_found_value                                        \n                            )\n                        }\n,\n\n    "get_rule": function($def)\n                    {\n                        {\n                            "message": $def.rule.Outcome.Message,\n                            "check_func": $eval("function($data){" & $def.rule.Check.all.operator & "}"),\n                            "variables": $def.rule.Outcome.Output_Variables,\n                            "scope": $def.rule.Scope.Entities\n                        }\n                    }\n,\n\n    "make_dup" : function($obj,$imap)\n                    {\n                        $obj ~> |**[id]|(\n                                            $merge(\n                                                $each(\n                                                    $sift(\n                                                        function($v,$k)\n                                                            {\n                                                                $contains($k,/id(s)?$/i) and $type($v) != "null"\n                                                            }\n                                                    ),\n                                                    function($v,$k)\n                                                        {\n                                                            (\n                                                                $get_id := function($id){($id in $keys($imap)) ? $lookup($imap, $id) : $id};\n                                                                {\n                                                                \n                                                                    $k: $contains($k,/Ids$/)\n                                                                        ? [$map($v,$get_id)]\n                                                                        : $get_id($v)\n                                                                \n                                                            \n                                                                }\n                                                            )\n                                                        }\n                                                )\n                                            )\n                                        )|\n                    }\n,\n\n    "parent_rel" : function($this, $parent)\n                    {\n                        $filter($keys($parent),\n                                function($k)\n                                {\n                                    (\n                                        $v := $lookup($parent,$k);\n                                        $type($v) = "array" ? $this in $v : $v = $this\n                                    )\n                                }\n                        )\n                    }\n,\n\n    "parse_refs":   function($from,$to,$within)\n                        {\n                            (\n                                $iter := function($dict)\n                                            {\n                                                $count($dict.**[$from in $keys($)]) > 0\n                                                ?   (\n                                                        $d := $dict ~> |**[$from in $keys($)]|\n                                                                {\n                                                                    $to: \n                                                                        (\n                                                                            $refs:=$lookup($,$from);\n                                                                            $map($refs,function($v)\n                                                                                {\n                                                                                    $v in $dict[id=$v].**.$lookup($,$from)\n                                                                                    ? {"circularReference": $v}\n                                                                                    : $dict[id=$v]\n                                                                                }\n                                                                            )\n                                                                        )\n                                                                },[$from]|;\n                                                        $iter($d)\n                                                    )\n                                                : $dict\n                                            };\n                                $iter($within)\n                            )\n                        }\n,\n\n    "report": function($rule,$data)\n                {\n                    (\n                        $errors := $append(null,$rule.check_func($data));\n                        $rule_applies := function($instyp,$rs)\n                                            {\n                                                (\n                                                    $incent := [$rs.Include];\n                                                    $excent := [$rs.Exclude];\n                                                    $is_inc := $instyp in $incent or "ALL" in $incent;\n                                                    $is_exc := $instyp in $excent or "ALL" in $excent;\n                                                    $is_inc and $not($is_exc)\n                                                )\n                                            };\n                        $data.**.instanceType@$it.($errors)\n                            {\n                                $it: \n                                    {\n                                        "executionStatus": "success",\n                                        "class": $it[0]\n                                    }\n                            } \n                            ~> |*|\n                                (\n                                    $class := $.class;\n                                    $rule_applies($class,$rule.scope)\n                                        ?\n                                            $class in $errors.instanceType \n                                                ? \n                                                    {\n                                                        "message": $rule.message,\n                                                        "errors" : $map($errors[instanceType = $class],\n                                                                        function($obj)\n                                                                            {\n                                                                                $merge($map($rule.variables, function($var)\n                                                                                        {\n                                                                                            {\n                                                                                                $var: $var in $keys($obj) ? $lookup($obj,$var) : "Not in output"\n                                                                                            }\n                                                                                        }\n                                                                                    )\n                                                                                )\n                                                                            }\n                                                                    )\n                                                    }\n                                                : {}\n                                        :   {\n                                                "executionStatus": "skipped",\n                                                "message": "Rule skipped - doesn\'t apply to entity for rule id=, dataset=" & $class\n                                            }\n                                )|\n                            ~> $spread() ~> $sort(function($l,$r){$keys($l)[0]>$keys($r)[0]}) ~> $merge()\n                    )\n                }\n,\n\n    "sift_tree" : function($tree,$find_val,$include,$prefix)\n                    {\n                        (\n                            $iter := function($t)\n                                    {\n                                        $type($t) = "array"\n                                        ?   [\n                                                $map($t,function($v)\n                                                    {\n                                                        $v.**.[$find_val in $]\n                                                        ? $iter($v)\n                                                    }\n                                                )\n                                            ]\n                                        :   $type($t) = "object"\n                                            ?   $t ~> \n                                                $sift(function($v,$k)\n                                                    {\n                                                        $k in $include or $v.**.[$find_val in $]\n                                                    }\n                                                ) ~>\n                                                $each(function($v, $k)\n                                                    {\n                                                        $k in $include\n                                                        ?   {$join([$prefix ? $t.instanceType,$k],"."): $v}\n                                                        :   {$join([$prefix ? $t.instanceType,$k],"."): $iter($v)}\n                                                    }) ~> $merge\n                                            :   $t\n                                    };\n                            $iter($tree)\n                        )\n                    }\n\n};\n($data.study.documentedBy)@$spd.\n    ($spd.versions)@$spdv.\n        ($spdv.contents[$contains(text,/usdm:ref/)])@$nc.\n            $match( $nc.text,\n                    /<usdm:ref([^>]*)(\\/>|><\\/usdm:ref>)/\n            )@$ref.\n            (\n                $g0_or_null := function($m){$m ? $m.groups[0] : null};\n                {\n                    "StudyProtocolDocument.id": $spd.id,\n                    "StudyProtocolDocument.name": $spd.name,\n                    "StudyProtocolDocumentVersion.id": $spdv.id,\n                    "StudyProtocolDocumentVersion.protocolVersion": $spdv.protocolVersion,\n                    "id": $nc.id,\n                    "name": $nc.name,\n                    "sectionNumber": $nc.sectionNumber,\n                    "sectionTitle": $nc.sectionTitle,\n                    "text": {\n                                "value": $nc.text,\n                                "usdm_ref": {\n                                                "match": $ref.match,\n                                                "klass": $match($ref.groups[0],/klass=\\"([a-zA-Z]+)\\"/) ~> $g0_or_null(),\n                                                "id": $match($ref.groups[0],/id=\\"(\\w+)\\"/) ~> $g0_or_null(),\n                                                "attribute": $match($ref.groups[0],/attribute=\\"([a-zA-Z]+)\\"/) ~> $g0_or_null()\n                                            }\n                    },                            \n                    "instanceType": $nc.instanceType\n                }\n            )\n            ~>  $map(function($v)\n                    {\n                        (\n                            $ref_val := "usdm_ref" in $keys($v.text)\n                                        ? $utils.get_ref_value($v.text.usdm_ref,$data,"!!NOT FOUND!!")\n                                        : $v.text.value;\n                            $v ~> |$|{"Referenced Value": $ref_val}|\n                        )\n                    }\n                )\n            ~>  $filter(function($v)\n                    {\n                        $v.`Referenced Value` = "!!NOT FOUND!!"\n                    }\n                )\n)'
print(full_string)