[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00194/DDF00194.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $old_study := $loadFile(\"./testdata/CDISC_Pilot_Study.json\");\r\n    $old_svid := $old_study.study.versions[0].id;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert copies of the first organization where there is     *\r\n    * only one address field present and populated.                         *\r\n    \\***********************************************************************/\r\n    $makeorg1:= function($study,$idx){( \r\n            $droplist:=$filter([\"text\",\"lines\",\"district\",\"city\",\"postalCode\",\"state\",\"country\"], function($v,$i){$i!=$idx-1});\r\n            $maxids := $utils.get_maxids($study);\r\n            $idmap := $utils.get_idmap($study.study.versions[0].organizations[2],$maxids);\r\n            $new_org := $utils.make_dup($study.study.versions[0].organizations[2],$idmap)\r\n                ~> |$|\r\n                    {\r\n                        \"name\": \"TESTORG\"&$idx,\r\n                        \"label\": \"Test Organization \"&$idx,\r\n                        \"managedSites\": []\r\n                    }|\r\n                ~> |type|{\"code\": \"C21541\", \"decode\": \"Healthcare Facility\"}|\r\n                ~> |legalAddress|{},$droplist|;\r\n            $new_org\r\n        )};\r\n    \r\n    $new_study:=$old_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg1($old_study,1))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg1($new_study,2))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg1($new_study,3))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg1($new_study,4))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg1($new_study,5))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg1($new_study,6))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg1($new_study,7))}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert copies of the first organization where there all    *\r\n    * fields are present but only is populated.                             *\r\n    \\***********************************************************************/\r\n    $makeorg2:= function($study,$idx){( \r\n            $droplist:=$filter([\"text\",\"lines\",\"district\",\"city\",\"postalCode\",\"state\",\"country\"], function($v,$i){$i!=$idx-1});\r\n            $setmiss:=$sift(\r\n                {\r\n                    \"text\": null,\r\n                    \"lines\": [],\r\n                    \"district\": null,\r\n                    \"city\": null,\r\n                    \"postalCode\": null,\r\n                    \"state\": null,\r\n                    \"country\": null\r\n                },function($v,$k){$k in $droplist}\r\n            );\r\n            $maxids := $utils.get_maxids($study);\r\n            $idmap := $utils.get_idmap($study.study.versions[0].organizations[2],$maxids);\r\n            $new_org := $utils.make_dup($study.study.versions[0].organizations[2],$idmap)\r\n                ~> |$|\r\n                    {\r\n                        \"name\": \"TESTORG\"&($idx+7),\r\n                        \"label\": \"Test Organization \"&($idx+7),\r\n                        \"managedSites\": []\r\n                    }|\r\n                ~> |type|{\"code\": \"C21541\", \"decode\": \"Healthcare Facility\"}|\r\n                ~> |legalAddress|$setmiss|;\r\n            $new_org\r\n        )};\r\n    \r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg2($new_study,1))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg2($new_study,2))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg2($new_study,3))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg2($new_study,4))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg2($new_study,5))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg2($new_study,6))}|;\r\n    $new_study:=$new_study ~> |study.versions[0]|{\"organizations\": $append(organizations, $makeorg2($new_study,7))}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00194/unit-test-coreid-DDF00194-positive-1.json\",$new_study);\r\n    \r\n    /***********************************************************************\\\r\n    * Make the following updates and then write out as negative unit test   *\r\n    * data:                                                                 *\r\n    * - Remove all address fields from the first organization.              *\r\n    * - Set all address fields to empty values in the second organization.  *\r\n    \\***********************************************************************/\r\n    $new_study1 := $old_study\r\n        ~> |study.versions[0].organizations[0].legalAddress|{},[\"text\",\"lines\",\"district\",\"city\",\"postalCode\",\"state\",\"country\"]|\r\n        ~> |study.versions[0].organizations[1].legalAddress|\r\n                {\r\n                    \"text\": \"\",\r\n                    \"lines\": [],\r\n                    \"district\": \"\",\r\n                    \"city\": \"\",\r\n                    \"postalCode\": \"\",\r\n                    \"state\": \"\",\r\n                    \"country\": \"\"\r\n                }|\r\n        ~> |study.versions[0].organizations[2].legalAddress|\r\n                {\r\n                    \"text\": null,\r\n                    \"lines\": [],\r\n                    \"district\": null,\r\n                    \"city\": null,\r\n                    \"postalCode\": null,\r\n                    \"state\": null,\r\n                    \"country\": null\r\n                }|;\r\n    $writeFile(\"./rules/DDF00194/unit-test-coreid-DDF00194-negative-1.json\",$new_study1);\r\n\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00194/unit-test-coreid-DDF00194-positive-1.json\");\r\n    $utils.report($rule,$pos_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00194/unit-test-coreid-DDF00194-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]