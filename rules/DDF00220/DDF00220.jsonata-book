[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00220/DDF00220.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point and add BC categories        *\r\n    \\***********************************************************************/\r\n\r\n    $old_study := $loadFile(\"./testdata/CDISC_Pilot_Study.json\")\r\n    ~> |study.versions[0].studyDesigns.subTypes|\r\n        {\r\n            \"code\":code=\"C99907x1\"?\"C207613\":code,\r\n            \"decode\": $substring(decode,0,1)&$lowercase($substring(decode,1))\r\n        }|;\r\n\r\n    $makestyp:=function($study,$code,$decode){\r\n        (\r\n            $maxids := $utils.get_maxids($study);\r\n            $idmap := $utils.get_idmap($study.study.versions[0].studyDesigns[0].subTypes[0],$maxids);\r\n            $new_char := $utils.make_dup($study.study.versions[0].studyDesigns[0].subTypes[0],$idmap)\r\n                ~> |$|  {\r\n                            \"code\": $code,\r\n                            \"decode\": $decode\r\n                        }|;\r\n        )\r\n    };\r\n\r\n    $old_study := $old_study ~> |study.versions[0].studyDesigns[0]|{\"subTypes\":$append(subTypes, $makestyp($old_study,\"C49656\",\"Treatment Study\"))}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study design                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.study.versions[0].studyDesigns[0],$maxids);\r\n    $new_sd1 := $utils.make_dup($old_study.study.versions[0].studyDesigns[0],$idmap)\r\n                ~> |$|  {\r\n                            \"name\": \"Study Design 2\",\r\n                            \"description\": \"A secondary design for the study\",\r\n                            \"subTypes\":\r\n                                $map(subTypes, function($v,$i){\r\n                                    $v ~> |$|  {\r\n                                        \"code\": [\"C158283\",\"C158284\",\"C49664\",\"C49665\"][$i],\r\n                                        \"decode\": [\r\n                                            \"Adhesion Performance Study\",\r\n                                            \"Alcohol Effect Study\",\r\n                                            \"Bioavailability Study\",\r\n                                            \"Therapeutic Equivalency Study\"][$i]\r\n                                    }|\r\n                                })\r\n                        }|;\r\n    $new_study1 := $old_study\r\n                ~> |study.versions[0]|{\"studyDesigns\": $append(studyDesigns,$new_sd1)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study design as an              *\r\n    * observational study design.                                           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap2 := $utils.get_idmap($new_study1.study.versions[0].studyDesigns[0],$maxids);\r\n    $new_sd2 := $utils.make_dup($new_study1.study.versions[0].studyDesigns[0],$idmap2)\r\n                ~> |$|{\r\n                        \"id\": \"ObservationalStudyDesign_1\",\r\n                        \"instanceType\": \"ObservationalStudyDesign\",\r\n                        \"name\": \"Study Design 3\",\r\n                        \"description\": \"An observational design for the study\",\r\n                        \"timePerspective\": (blindingSchema.standardCode ~> |$|{\"code\": \"C15273\",\"decode\": \"PROSPECTIVE\"}|),\r\n                        \"subTypes\":\r\n                            $map(subTypes, function($v,$i){\r\n                                $v ~> |$|  {\r\n                                    \"code\": [\"C215675\",\"C215655\",\"C215656\",\"C49667\"][$i],\r\n                                    \"decode\": [\r\n                                        \"Disease Prevalence\",\r\n                                        \"Disease Prognosis\",\r\n                                        \"Drug Utilization\",\r\n                                        \"Safety\"][$i]\r\n                                }|\r\n                            })\r\n                      },[\"blindingSchema\",\"intentTypes\"]|\r\n                ~> |studyType|{\"code\": \"C16084\", \"decode\": \"OBSERVATIONAL\"}|\r\n                ~> |model|{\"code\": \"C15208\", \"decode\": \"COHORT\"}|;\r\n    $new_study2 := $new_study1\r\n                ~> |study.versions[0]|{\"studyDesigns\": $append(studyDesigns,$new_sd2)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00220/unit-test-coreid-DDF00220-positive-1.json\",$new_study2);\r\n    \r\n    /***********************************************************************\\\r\n    * Make the following updates then write out as negative unit test data: *\r\n    * - Insert a new characteristic for the first study design as a copy of *\r\n    *   the first characteristic, but using NCI preferred terms as decode.  *\r\n    * - Apply the same code for the first 3 subTypes of the second   *\r\n    *   study design.                                                       *\r\n    * - Duplicate the codes for the first/second and third/fourth           *\r\n    *   subTypes for the third study design.                         *\r\n    \\***********************************************************************/\r\n    $first_code1:= $new_study2.study.versions[0].studyDesigns[0].subTypes[0].code;\r\n    $first_code2:= $new_study2.study.versions[0].studyDesigns[1].subTypes[0].code;\r\n    $first_code3:= $new_study2.study.versions[0].studyDesigns[2].subTypes[0].code;\r\n    $third_code3:= $new_study2.study.versions[0].studyDesigns[2].subTypes[2].code;\r\n    $new_study3 := $new_study2\r\n        ~> |study.versions[0].studyDesigns[0]|{\"subTypes\": $append(subTypes, $makestyp($new_study2,$first_code1,\"EFFICACY\"))}|;\r\n    $new_study3 := $new_study3\r\n                    ~> |study.versions[0].studyDesigns[1].subTypes[[1..2]]|{\"code\": $first_code2}|\r\n                    ~> |study.versions[0].studyDesigns[2].subTypes[1]|{\"code\": $first_code3}|\r\n                    ~> |study.versions[0].studyDesigns[2].subTypes[3]|{\"code\": $third_code3}|;\r\n    $writeFile(\"./rules/DDF00220/unit-test-coreid-DDF00220-negative-1.json\",$new_study3);\r\n    $list:=function($study){\r\n          $study.study.versions.studyDesigns{id:subTypes.(\"** code=\"&code&\", decode='\"&decode&\"'\")} ~>\r\n        $each(function($v,$k){\"* \"&$k&\"\\n\"&$join($v,\"\\n\")})~>$join(\"\\n\")\r\n    };\r\n    \"Positive:\\n\"&$list($new_study2)&\"\\nNegative:\\n\"&$list($new_study3)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive dataset","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00220/unit-test-coreid-DDF00220-positive-1.json\");\r\n    $utils.report($rule,$pos_data)\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00220/unit-test-coreid-DDF00220-negative-1.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]