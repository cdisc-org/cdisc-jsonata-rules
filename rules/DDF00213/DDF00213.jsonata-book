[{"kind":1,"language":"markdown","value":"Import utility functions","outputs":[]},{"kind":2,"language":"jsonata","value":"$utils := $merge([$import(\"./utils/get_idmap.jsonata\")\r\n                 ,$import(\"./utils/get_maxids.jsonata\")\r\n                 ,$import(\"./utils/make_dup.jsonata\")\r\n                 ,$import(\"./utils/get_rule.jsonata\")\r\n                 ,$import(\"./utils/report.jsonata\")]) ","outputs":[]},{"kind":1,"language":"markdown","value":"Define test","outputs":[]},{"kind":2,"language":"jsonata","value":"$rule := $utils.get_rule($import(\"./rules/DDF00213/DDF00213.json\"))","outputs":[]},{"kind":1,"language":"markdown","value":"Create test data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    /***********************************************************************\\\r\n    * Use the CDISC Pilot data as a start point                             *\r\n    \\***********************************************************************/\r\n\r\n    $old_study :=   $loadFile(\"./testdata/CDISC_Pilot_Study.json\");\r\n\r\n    $new_ap1 := {\r\n                    \"id\": \"AdministrableProduct_1\",\r\n                    \"name\": \"AP_FORME_54\",\r\n                    \"label\": \"Xanomeline 54mg Formulation E\",\r\n                    \"administrableDoseForm\": {\r\n                        \"id\": \"AliasCode_254\",\r\n                        \"standardCode\": {\r\n                            \"id\": \"Code_679\",\r\n                            \"code\": \"C42968\",\r\n                            \"codeSystem\": \"http://www.cdisc.org\",\r\n                            \"codeSystemVersion\": \"2024-09-27\",\r\n                            \"decode\": \"PATCH\",\r\n                            \"instanceType\": \"Code\"\r\n                        },\r\n                        \"instanceType\": \"AliasCode\"\r\n                    },\r\n                    \"productDesignation\": {\r\n                        \"id\": \"Code_680\",\r\n                        \"code\": \"C202579\",\r\n                        \"codeSystem\": \"http://www.cdisc.org\",\r\n                        \"codeSystemVersion\": \"2024-09-27\",\r\n                        \"decode\": \"IMP\",\r\n                        \"instanceType\": \"Code\"\r\n                    },\r\n                    \"ingredients\": [\r\n                        {\r\n                            \"id\": \"Ingredient_1\",\r\n                            \"role\": {\r\n                                \"id\": \"Code_681\",\r\n                                \"code\": \"100000072072\",\r\n                                \"codeSystem\": \"http://hl7.org/fhir/ValueSet/ingredient-role\",\r\n                                \"codeSystemVersion\": \"2020-12-28\",\r\n                                \"decode\": \"Active\",\r\n                                \"instanceType\": \"Code\"\r\n                            },\r\n                            \"substance\": {\r\n                                \"id\": \"Substance_1\",\r\n                                \"name\": \"SBST_XANO_54\",\r\n                                \"label\": \"54 mg xanomeline freebase\",\r\n                                \"strengths\": [\r\n                                    {\r\n                                        \"id\": \"Strength_1\",\r\n                                        \"name\": \"STRENGTH1\",\r\n                                        \"numerator\": {\r\n                                            \"id\": \"Quantity_11\",\r\n                                            \"value\": 54,\r\n                                            \"unit\": {\r\n                                                \"id\": \"AliasCode_255\",\r\n                                                \"standardCode\": {\r\n                                                    \"id\": \"Code_682\",\r\n                                                    \"code\": \"C28253\",\r\n                                                    \"codeSystem\": \"http://www.cdisc.org\",\r\n                                                    \"codeSystemVersion\": \"2024-09-27\",\r\n                                                    \"decode\": \"mg\",\r\n                                                    \"instanceType\": \"Code\"\r\n                                                },\r\n                                                \"instanceType\": \"AliasCode\"\r\n                                            },\r\n                                            \"instanceType\": \"Quantity\"\r\n                                        },\r\n                                        \"instanceType\": \"Strength\"\r\n                                    }\r\n                                ],\r\n                                \"instanceType\": \"Substance\"\r\n                            },\r\n                            \"instanceType\": \"Ingredient\"\r\n                        },\r\n                        {\r\n                            \"id\": \"Ingredient_2\",\r\n                            \"role\": {\r\n                                \"id\": \"Code_683\",\r\n                                \"code\": \"100000072073\",\r\n                                \"codeSystem\": \"http://hl7.org/fhir/ValueSet/ingredient-role\",\r\n                                \"codeSystemVersion\": \"2020-12-28\",\r\n                                \"decode\": \"Adjuvant\",\r\n                                \"instanceType\": \"Code\"\r\n                            },\r\n                            \"substance\": {\r\n                                \"id\": \"Substance_2\",\r\n                                \"name\": \"SBST_VITE_6\",\r\n                                \"label\": \"0.06 mg Vitamin E USP\",\r\n                                \"strengths\": [\r\n                                    {\r\n                                        \"id\": \"Strength_2\",\r\n                                        \"name\": \"STRENGTH2\",\r\n                                        \"numerator\": {\r\n                                            \"id\": \"Quantity_12\",\r\n                                            \"value\": 0.06,\r\n                                            \"unit\": {\r\n                                                \"id\": \"AliasCode_256\",\r\n                                                \"standardCode\": {\r\n                                                    \"id\": \"Code_684\",\r\n                                                    \"code\": \"C28253\",\r\n                                                    \"codeSystem\": \"http://www.cdisc.org\",\r\n                                                    \"codeSystemVersion\": \"2024-09-27\",\r\n                                                    \"decode\": \"mg\",\r\n                                                    \"instanceType\": \"Code\"\r\n                                                },\r\n                                                \"instanceType\": \"AliasCode\"\r\n                                            },\r\n                                            \"instanceType\": \"Quantity\"\r\n                                        },\r\n                                        \"instanceType\": \"Strength\"\r\n                                    }\r\n                                ],\r\n                                \"instanceType\": \"Substance\"\r\n                            },\r\n                            \"instanceType\": \"Ingredient\"\r\n                        }\r\n                    ],\r\n                    \"instanceType\": \"AdministrableProduct\"\r\n                };\r\n\r\n    $new_ap2 := {\r\n                    \"id\": \"AdministrableProduct_2\",\r\n                    \"name\": \"AP_FORME_27\",\r\n                    \"label\": \"Xanomeline 27mg Formulation E\",\r\n                    \"administrableDoseForm\": {\r\n                        \"id\": \"AliasCode_257\",\r\n                        \"standardCode\": {\r\n                            \"id\": \"Code_685\",\r\n                            \"code\": \"C42968\",\r\n                            \"codeSystem\": \"http://www.cdisc.org\",\r\n                            \"codeSystemVersion\": \"2024-09-27\",\r\n                            \"decode\": \"PATCH\",\r\n                            \"instanceType\": \"Code\"\r\n                        },\r\n                        \"instanceType\": \"AliasCode\"\r\n                    },\r\n                    \"productDesignation\": {\r\n                        \"id\": \"Code_686\",\r\n                        \"code\": \"C202579\",\r\n                        \"codeSystem\": \"http://www.cdisc.org\",\r\n                        \"codeSystemVersion\": \"2024-09-27\",\r\n                        \"decode\": \"IMP\",\r\n                        \"instanceType\": \"Code\"\r\n                    },\r\n                    \"ingredients\": [\r\n                        {\r\n                            \"id\": \"Ingredient_3\",\r\n                            \"role\": {\r\n                                \"id\": \"Code_687\",\r\n                                \"code\": \"100000072072\",\r\n                                \"codeSystem\": \"http://hl7.org/fhir/ValueSet/ingredient-role\",\r\n                                \"codeSystemVersion\": \"2020-12-28\",\r\n                                \"decode\": \"Active\",\r\n                                \"instanceType\": \"Code\"\r\n                            },\r\n                            \"substance\": {\r\n                                \"id\": \"Substance_3\",\r\n                                \"name\": \"SBST_XANO_27\",\r\n                                \"label\": \"54 mg xanomeline freebase\",\r\n                                \"strengths\": [\r\n                                    {\r\n                                        \"id\": \"Strength_3\",\r\n                                        \"name\": \"STRENGTH1\",\r\n                                        \"numerator\": {\r\n                                            \"id\": \"Quantity_13\",\r\n                                            \"value\": 27,\r\n                                            \"unit\": {\r\n                                                \"id\": \"AliasCode_258\",\r\n                                                \"standardCode\": {\r\n                                                    \"id\": \"Code_688\",\r\n                                                    \"code\": \"C28253\",\r\n                                                    \"codeSystem\": \"http://www.cdisc.org\",\r\n                                                    \"codeSystemVersion\": \"2024-09-27\",\r\n                                                    \"decode\": \"mg\",\r\n                                                    \"instanceType\": \"Code\"\r\n                                                },\r\n                                                \"instanceType\": \"AliasCode\"\r\n                                            },\r\n                                            \"instanceType\": \"Quantity\"\r\n                                        },\r\n                                        \"instanceType\": \"Strength\"\r\n                                    }\r\n                                ],\r\n                                \"instanceType\": \"Substance\"\r\n                            },\r\n                            \"instanceType\": \"Ingredient\"\r\n                        },\r\n                        {\r\n                            \"id\": \"Ingredient_4\",\r\n                            \"role\": {\r\n                                \"id\": \"Code_689\",\r\n                                \"code\": \"100000072073\",\r\n                                \"codeSystem\": \"http://hl7.org/fhir/ValueSet/ingredient-role\",\r\n                                \"codeSystemVersion\": \"2020-12-28\",\r\n                                \"decode\": \"Adjuvant\",\r\n                                \"instanceType\": \"Code\"\r\n                            },\r\n                            \"substance\": {\r\n                                \"id\": \"Substance_4\",\r\n                                \"name\": \"SBST_VITE_3\",\r\n                                \"label\": \"0.03 mg Vitamin E USP\",\r\n                                \"strengths\": [\r\n                                    {\r\n                                        \"id\": \"Strength_4\",\r\n                                        \"name\": \"STRENGTH2\",\r\n                                        \"numerator\": {\r\n                                            \"id\": \"Quantity_14\",\r\n                                            \"value\": 0.03,\r\n                                            \"unit\": {\r\n                                                \"id\": \"AliasCode_259\",\r\n                                                \"standardCode\": {\r\n                                                    \"id\": \"Code_690\",\r\n                                                    \"code\": \"C28253\",\r\n                                                    \"codeSystem\": \"http://www.cdisc.org\",\r\n                                                    \"codeSystemVersion\": \"2024-09-27\",\r\n                                                    \"decode\": \"mg\",\r\n                                                    \"instanceType\": \"Code\"\r\n                                                },\r\n                                                \"instanceType\": \"AliasCode\"\r\n                                            },\r\n                                            \"instanceType\": \"Quantity\"\r\n                                        },\r\n                                        \"instanceType\": \"Strength\"\r\n                                    }\r\n                                ],\r\n                                \"instanceType\": \"Substance\"\r\n                            },\r\n                            \"instanceType\": \"Ingredient\"\r\n                        }\r\n                    ],\r\n                    \"instanceType\": \"AdministrableProduct\"\r\n                };\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study design                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($old_study);\r\n    $idmap := $utils.get_idmap($old_study.study.versions[0].studyDesigns[0],$maxids);\r\n    $new_sd := $utils.make_dup($old_study.study.versions[0].studyDesigns[0],$idmap)\r\n                ~> |$|  {\r\n                            \"name\": \"Study Design 2\",\r\n                            \"description\": \"A secondary design for the study\",\r\n                            \"arms\": [arms[1]],\r\n                            \"studyInterventionIds\": []\r\n                        }|\r\n                ~> |$|{\"studyCells\": ($this := $; studyCells[armId in $this.arms.id])}|\r\n                ~> |$|{\"elements\": ($this := $; elements[id in $this.studyCells.elementIds])}|\r\n                ~> |model|{\"code\": \"C82640\", \"decode\": \"SINGLE GROUP\"}|;\r\n    $new_study1 := $old_study\r\n                ~> |study.versions[0]|\r\n                    {\r\n                        \"administrableProducts\": [$new_ap1,$new_ap2],\r\n                        \"medicalDevices\": [\r\n                            {\r\n                                \"id\": \"MedicalDevice_1\",\r\n                                \"name\": \"MD_PLAC_50\",\r\n                                \"label\": \"Placebo TTS 5Ocm2 Patch\",\r\n                                \"instanceType\": \"MedicalDevice\"\r\n                            },\r\n                                        {\r\n                                \"id\": \"MedicalDevice_2\",\r\n                                \"name\": \"MD_PLAC_25\",\r\n                                \"label\": \"Placebo TTS 25cm2 Patch\",\r\n                                \"instanceType\": \"MedicalDevice\"\r\n                            },\r\n                            {\r\n                                \"id\": \"MedicalDevice_3\",\r\n                                \"name\": \"MD_XANO_50\",\r\n                                \"label\": \"Xanomeline TTS 5Ocm2 Patch\",\r\n                                \"embeddedProductId\": \"AdministrableProduct_1\",\r\n                                \"instanceType\": \"MedicalDevice\"\r\n                            },\r\n                            {\r\n                                \"id\": \"MedicalDevice_4\",\r\n                                \"name\": \"MD_XANO_25\",\r\n                                \"label\": \"Xanomeline TTS 25cm2 Patch\",\r\n                                \"embeddedProductId\": \"AdministrableProduct_2\",\r\n                                \"instanceType\": \"MedicalDevice\"\r\n                            }\r\n                        ],\r\n                        \"studyDesigns\": $append(studyDesigns,$new_sd)\r\n                    }|\r\n                ~> |study.versions[0].roles[0]|{\"appliesToIds\": [$old_svid]}|\r\n                ~> |study.versions[0].studyInterventions[0]|\r\n                    {             \r\n                        \"id\": \"StudyIntervention_1\",\r\n                        \"name\": \"SI_XAN_LO\",\r\n                        \"label\": \"Xanomeline Low Dose\",\r\n                        \"description\": \"Xanomeline Low Dose\",\r\n                        \"type\": {\r\n                            \"id\": \"Code_612\",\r\n                            \"extensionAttributes\": [],\r\n                            \"code\": \"C1909\",\r\n                            \"codeSystem\": \"http://www.cdisc.org\",\r\n                            \"codeSystemVersion\": \"2024-09-27\",\r\n                            \"decode\": \"DRUG\",\r\n                            \"instanceType\": \"Code\"\r\n                        },\r\n                        \"codes\": [\r\n                        {\r\n                            \"id\": \"Code_610\",\r\n                            \"extensionAttributes\": [],\r\n                            \"code\": \"XAN\",\r\n                            \"codeSystem\": \"SPONSOR\",\r\n                            \"codeSystemVersion\": \"12\",\r\n                            \"decode\": \"XAN\",\r\n                            \"instanceType\": \"Code\"\r\n                        }\r\n                        ],\r\n                        \"administrations\": [\r\n                            {\r\n                                \"id\": \"Administration_1\",\r\n                                \"extensionAttributes\": [],\r\n                                \"name\": \"ADM_XL_P50_A\",\r\n                                \"label\": \"50 cm2 Patch\",\r\n                                \"description\": \"50 cm2 Patch (Active)\",\r\n                                \"duration\": {\r\n                                    \"id\": \"Duration_1\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"text\": \"\",\r\n                                    \"quantity\": {\r\n                                        \"id\": \"Quantity_2\",\r\n                                        \"extensionAttributes\": [],\r\n                                        \"value\": 24,\r\n                                        \"unit\": {\r\n                                            \"id\": \"AliasCode_242\",\r\n                                            \"extensionAttributes\": [],\r\n                                            \"standardCode\": {\r\n                                                \"id\": \"Code_606\",\r\n                                                \"extensionAttributes\": [],\r\n                                                \"code\": \"C29844\",\r\n                                                \"codeSystem\": \"http://www.cdisc.org\",\r\n                                                \"codeSystemVersion\": \"2024-09-27\",\r\n                                                \"decode\": \"Week\",\r\n                                                \"instanceType\": \"Code\"\r\n                                            },\r\n                                            \"standardCodeAliases\": [],\r\n                                            \"instanceType\": \"AliasCode\"\r\n                                        },\r\n                                        \"instanceType\": \"Quantity\"\r\n                                    },\r\n                                    \"durationWillVary\": false,\r\n                                    \"reasonDurationWillVary\": null,\r\n                                    \"instanceType\": \"Duration\"\r\n                                },\r\n                                \"frequency\": {\r\n                                    \"id\": \"AliasCode_245\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"standardCode\": {\r\n                                        \"id\": \"Code_609\",\r\n                                        \"extensionAttributes\": [],\r\n                                        \"code\": \"C25473\",\r\n                                        \"codeSystem\": \"http://www.cdisc.org\",\r\n                                        \"codeSystemVersion\": \"2024-09-27\",\r\n                                        \"decode\": \"Daily\",\r\n                                        \"instanceType\": \"Code\"\r\n                                    },\r\n                                    \"standardCodeAliases\": [],\r\n                                    \"instanceType\": \"AliasCode\"\r\n                                },\r\n                                \"administrableProductId\": null,\r\n                                \"medicalDeviceId\": \"MedicalDevice_3\",\r\n                                \"notes\": [],\r\n                                \"instanceType\": \"Administration\"\r\n                            },\r\n                            {\r\n                                \"id\": \"Administration_2\",\r\n                                \"extensionAttributes\": [],\r\n                                \"name\": \"ADM_XL_P25_P\",\r\n                                \"label\": \"25 cm2 Patch\",\r\n                                \"description\": \"25 cm2 Patch (Placebo)\",\r\n                                \"duration\": {\r\n                                    \"id\": \"Duration_2\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"text\": \"\",\r\n                                    \"quantity\": {\r\n                                        \"id\": \"Quantity_5\",\r\n                                        \"extensionAttributes\": [],\r\n                                        \"value\": 24,\r\n                                        \"unit\": {\r\n                                            \"id\": \"AliasCode_247\",\r\n                                            \"extensionAttributes\": [],\r\n                                            \"standardCode\": {\r\n                                                \"id\": \"Code_614\",\r\n                                                \"extensionAttributes\": [],\r\n                                                \"code\": \"C29844\",\r\n                                                \"codeSystem\": \"http://www.cdisc.org\",\r\n                                                \"codeSystemVersion\": \"2024-09-27\",\r\n                                                \"decode\": \"Week\",\r\n                                                \"instanceType\": \"Code\"\r\n                                            },\r\n                                            \"standardCodeAliases\": [],\r\n                                            \"instanceType\": \"AliasCode\"\r\n                                        },\r\n                                        \"instanceType\": \"Quantity\"\r\n                                    },\r\n                                    \"durationWillVary\": false,\r\n                                    \"reasonDurationWillVary\": \"Need reason\",\r\n                                    \"instanceType\": \"Duration\"\r\n                                },\r\n                                \"frequency\": {\r\n                                    \"id\": \"AliasCode_250\",\r\n                                    \"extensionAttributes\": [],\r\n                                    \"standardCode\": {\r\n                                        \"id\": \"Code_617\",\r\n                                        \"extensionAttributes\": [],\r\n                                        \"code\": \"C25473\",\r\n                                        \"codeSystem\": \"http://www.cdisc.org\",\r\n                                        \"codeSystemVersion\": \"2024-09-27\",\r\n                                        \"decode\": \"Daily\",\r\n                                        \"instanceType\": \"Code\"\r\n                                    },\r\n                                    \"standardCodeAliases\": [],\r\n                                    \"instanceType\": \"AliasCode\"\r\n                                },\r\n                                \"administrableProductId\": null,\r\n                                \"medicalDeviceId\": \"MedicalDevice_2\",\r\n                                \"notes\": [],\r\n                                \"instanceType\": \"Administration\"\r\n                            }\r\n                        ],\r\n                        \"notes\": [],\r\n                        \"instanceType\": \"StudyIntervention\"\r\n                    }\r\n                    |;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study intervention              *\r\n    \\***********************************************************************/\r\n    $old_si := $new_study1.study.versions[0].studyInterventions[0];\r\n    $maxids := $utils.get_maxids($new_study1);\r\n    $idmap := $utils.get_idmap($old_si,$maxids);\r\n    $new_si1 := $utils.make_dup($old_si,$idmap)\r\n                ~> |$|  {\r\n                            \"name\": \"SI_XAN_HI\",\r\n                            \"label\": \"Xanomeline High Dose\",\r\n                            \"description\": \"Xanomeline High Dose\"\r\n                        }|\r\n                ~> |administrations|{\"name\": $replace(name,/XL/,\"XH\")}|\r\n                ~> |administrations[1]| {\r\n                                            \"name\": $replace(name,/_P$/,\"_A\"),\r\n                                            \"description\": $replace(description,/Placebo/,\"Active\"),\r\n                                            \"medicalDeviceId\": \"MedicalDevice_4\"\r\n                                        }|;\r\n    $new_study2 := $new_study1\r\n                ~> |study.versions[0]|{\"studyInterventions\": $append(studyInterventions,$new_si1)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert another copy of the first study intervention        *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study2);\r\n    $idmap := $utils.get_idmap($new_study2.study.versions[0].studyInterventions[0],$maxids);\r\n    $new_si2 := $utils.make_dup($new_study2.study.versions[0].studyInterventions[0],$idmap)\r\n                ~> |$|  {\r\n                            \"name\": \"SI_PLAC\",\r\n                            \"label\": \"Placebo\",\r\n                            \"description\": \"Placebo\"\r\n                        },[\"minimumResponseDuration\"]|\r\n                ~> |role|{\"code\": \"C753\", \"decode\": \"Placebo\"}|\r\n                ~> |codes[0]|{\"code\": \"PBO\", \"decode\": \"PBO\"}|\r\n                ~> |administrations|{\"name\": $replace(name,/XL/,\"P\")}|\r\n                ~> |administrations[0]| {\r\n                                            \"name\": $replace(name,/_A/,\"_P\"),\r\n                                            \"description\": $replace(description,/Active/,\"Placebo\"),\r\n                                            \"medicalDeviceId\": \"MedicalDevice_1\"\r\n                                        }|;\r\n    $new_study3 := $new_study2\r\n                ~> |study.versions[0]|{\"studyInterventions\": $append(studyInterventions,$new_si2)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study design                    *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study3);\r\n    $idmap := $utils.get_idmap($new_study3.study.versions[0].studyDesigns[0],$maxids);\r\n    $new_sd1 := $utils.make_dup($new_study3.study.versions[0].studyDesigns[0],$idmap)\r\n                ~> |$|  {\r\n                            \"name\": \"Study Design 3\",\r\n                            \"description\": \"A tertiary design for the study\",\r\n                            \"arms\": [arms[2]],\r\n                            \"studyInterventionIds\": [$old_si.id,$new_si1.id]\r\n                        }|\r\n                ~> |$|{\"studyCells\": ($this := $; studyCells[armId in $this.arms.id])}|\r\n                ~> |$|{\"elements\": ($this := $; elements[id in $this.studyCells.elementIds])}|\r\n                ~> |model|{\"code\": \"C82640\", \"decode\": \"SINGLE GROUP\"}|\r\n                ~> |elements[name in [\"EL4\",\"EL6\"]]|{\"studyInterventionIds\": [$old_si.id]}|\r\n                ~> |elements[name = \"EL5\"]|{\"studyInterventionIds\": [$new_si1.id]}|;\r\n    $new_study4 := $new_study3\r\n                ~> |study.versions[0]|{\"studyDesigns\": $append(studyDesigns,$new_sd1)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Create and insert a copy of the first study design as an              *\r\n    * observational study design.                                           *\r\n    \\***********************************************************************/\r\n    $maxids := $utils.get_maxids($new_study4);\r\n    $idmap := $utils.get_idmap($new_study4.study.versions[0].studyDesigns[0],$maxids);\r\n    $new_sd2 := $utils.make_dup($new_study4.study.versions[0].studyDesigns[0],$idmap)\r\n                ~> |$|{\r\n                        \"id\": \"ObservationalStudyDesign_1\",\r\n                        \"instanceType\": \"ObservationalStudyDesign\",\r\n                        \"name\": \"Study Design 4\",\r\n                        \"description\": \"An observational design for the study\",\r\n                        \"timePerspective\": (blindingSchema ~> |standardCode|{\"code\": \"C15273\",\"decode\": \"PROSPECTIVE\"}|)\r\n                      },[\"blindingSchema\",\"intentTypes\",\"subTypes\"]|\r\n                ~> |studyType|{\"code\": \"C16084\", \"decode\": \"OBSERVATIONAL\"}|\r\n                ~> |model|{\"code\": \"C15208\", \"decode\": \"COHORT\"}|;\r\n    $new_study5 := $new_study4\r\n                ~> |study.versions[0]|{\"studyDesigns\": $append(studyDesigns,$new_sd2)}|;\r\n\r\n    /***********************************************************************\\\r\n    * Write out as negative unit test data (refs to study interventions are *\r\n    * missing from the original example data). Only the first study design  *\r\n    * is expected to be reported.                                           *\r\n    \\***********************************************************************/\r\n    $writeFile(\"./rules/DDF00213/unit-test-coreid-DDF00213-negative.json\",$new_study5);\r\n    \r\n    /***********************************************************************\\\r\n    * Add the refs to study interventions to one of the activities and      *\r\n    * write out as positive unit test data.                                 *\r\n    \\***********************************************************************/\r\n    $si_ids := $new_study5.study.versions[0].studyInterventions.id[];\r\n\r\n    $maxids := $utils.get_maxids($new_study5);\r\n    $idmap := $utils.get_idmap($new_study5.study.versions[0].studyDesigns[0].activities[id=\"Activity_18\"].definedProcedures[0],$maxids);\r\n    $new_dp1 := $utils.make_dup($new_study5.study.versions[0].studyDesigns[0].activities[id=\"Activity_18\"].definedProcedures[0],$idmap)\r\n                ~> |$|  {\r\n                            \"name\": \"PR_DISP\",\r\n                            \"label\": \"Medications dispensed\",\r\n                            \"description\": \"Medications dispensed\",\r\n                            \"procedureType\": \"Disposition\",\r\n                            \"studyInterventionId\": $si_ids[0]\r\n                        }| \r\n                ~> |code|{\"code\": \"373784005\", \"decode\": \"Dispensing medication\"}|;\r\n    $new_study6 :=  $new_study5\r\n                    ~> |study.versions[0].studyDesigns[0].activities[id=\"Activity_25\"]|\r\n                        {\r\n                            \"definedProcedures\"[]: [$new_dp1]\r\n                        }|;\r\n                        \r\n    $maxids := $utils.get_maxids($new_study6);\r\n    $idmap := $utils.get_idmap($new_study6.study.versions[0].studyDesigns[0].activities[id=\"Activity_18\"].definedProcedures[0],$maxids);\r\n    $new_dp2 := $utils.make_dup($new_study6.study.versions[0].studyDesigns[0].activities[id=\"Activity_18\"].definedProcedures[0],$idmap)\r\n                ~> |$|  {\r\n                            \"name\": \"PR_RECON\",\r\n                            \"label\": \"Medications reconciliation\",\r\n                            \"description\": \"Medications reconciliation\",\r\n                            \"procedureType\": \"Disposition\",\r\n                            \"studyInterventionId\": $si_ids[0]\r\n                        }| \r\n                ~> |code|{\"code\": \"430193006\", \"decode\": \"Medication reconciliation\"}|;\r\n    $new_study7 :=  $new_study6\r\n                ~> |study.versions[0].studyDesigns[0]|{\"studyInterventionIds\": [$old_si.id,$new_si1.id,$new_si2.id]}|\r\n                ~> |study.versions[0].studyDesigns[0].elements[name = \"EL2\"]|{\"studyInterventionIds\": [$new_si2.id]}|\r\n                ~> |study.versions[0].studyDesigns[0].elements[name in [\"EL3\",\"EL4\",\"EL6\"]]|{\"studyInterventionIds\": [$old_si.id]}|\r\n                ~> |study.versions[0].studyDesigns[0].elements[name = \"EL5\"]|{\"studyInterventionIds\": [$new_si1.id]}|\r\n                ~> |study.versions[0].studyDesigns[1]|{\"studyInterventionIds\": [$old_si.id]}|\r\n                ~> |study.versions[0].studyDesigns[1].elements[name = \"EL3\"]|{\"studyInterventionIds\": [$old_si.id]}|\r\n                ~> |study.versions[0].studyDesigns[2]|{\"studyInterventionIds\": [$new_si1.id]}|\r\n                ~> |study.versions[0].studyDesigns[2].elements[name in [\"EL4\",\"EL6\"]]|{\"studyInterventionIds\": [$new_si1.id]}|\r\n                    ~> |study.versions[0].studyDesigns[0].activities[id=\"Activity_25\"]|\r\n                        {\r\n                            \"definedProcedures\"[]: $append(definedProcedures,$new_dp2)\r\n                        }|;\r\n                        \r\n    $writeFile(\"./rules/DDF00213/unit-test-coreid-DDF00213-positive.json\",$new_study7);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test positive data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $pos_data := $loadFile(\"./rules/DDF00213/unit-test-coreid-DDF00213-positive.json\");\r\n    $utils.report($rule,$pos_data);\r\n)","outputs":[]},{"kind":1,"language":"markdown","value":"Test negative data","outputs":[]},{"kind":2,"language":"jsonata","value":"(\r\n    $neg_data := $loadFile(\"./rules/DDF00213/unit-test-coreid-DDF00213-negative.json\");\r\n    $utils.report($rule,$neg_data)\r\n)","outputs":[]}]